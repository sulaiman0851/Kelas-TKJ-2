---
import Layout from "../../layouts/Layout.astro";

export const prerender = false;
---

<Layout title="Scan QR Attendance - Kelas TKJ">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div
            class="max-w-xl w-full bg-slate-900 border border-white/5 rounded-[3rem] overflow-hidden shadow-2xl relative"
        >
            <!-- Header -->
            <div
                class="p-8 border-b border-white/5 bg-white/2 text-center relative z-10"
            >
                <h1
                    class="text-3xl font-black text-white mb-2 uppercase tracking-tighter"
                >
                    QR Scanner
                </h1>
                <p class="text-slate-500 text-sm font-medium italic">
                    Arahkan kamera ke kode QR yang ada di depan kelas
                </p>
            </div>

            <!-- Scanner Area -->
            <div
                class="relative aspect-square md:aspect-video bg-black flex items-center justify-center overflow-hidden"
            >
                <div id="reader" class="w-full h-full"></div>

                <!-- Overlay Guide -->
                <div
                    id="scanner-overlay"
                    class="absolute inset-0 pointer-events-none flex items-center justify-center z-20"
                >
                    <div
                        class="w-64 h-64 border-2 border-blue-500/50 rounded-3xl relative"
                    >
                        <!-- Corners -->
                        <div
                            class="absolute -top-1 -left-1 w-8 h-8 border-t-4 border-l-4 border-blue-500 rounded-tl-xl"
                        >
                        </div>
                        <div
                            class="absolute -top-1 -right-1 w-8 h-8 border-t-4 border-r-4 border-blue-500 rounded-tr-xl"
                        >
                        </div>
                        <div
                            class="absolute -bottom-1 -left-1 w-8 h-8 border-b-4 border-l-4 border-blue-500 rounded-bl-xl"
                        >
                        </div>
                        <div
                            class="absolute -bottom-1 -right-1 w-8 h-8 border-b-4 border-r-4 border-blue-500 rounded-br-xl"
                        >
                        </div>

                        <!-- Scanning Line -->
                        <div
                            class="absolute inset-0 bg-blue-500/10 animate-scan"
                        >
                        </div>
                    </div>
                </div>

                <!-- Error Messages -->
                <div
                    id="camera-error"
                    class="hidden absolute inset-0 bg-slate-950/90 z-30 flex flex-col items-center justify-center p-8 text-center text-white"
                >
                    <div
                        class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mb-4 border border-red-500/50"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="32"
                            height="32"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            class="text-red-400"
                            ><path d="m2 2 20 20"></path><path
                                d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h2"
                            ></path><path d="M13 13.5a3 3 0 1 0-4.5-4.5"
                            ></path><path d="M22 17V9a2 2 0 0 0-2-2h-2"
                            ></path><path d="M12 7l-2-3"></path></svg
                        >
                    </div>
                    <h3 class="text-xl font-bold mb-2">Izin Kamera Ditolak</h3>
                    <p class="text-slate-400 text-sm mb-6">
                        Pastikan Anda telah memberikan izin kamera pada browser
                        Anda.
                    </p>
                    <button
                        onclick="window.location.reload()"
                        class="px-6 py-3 bg-white text-black font-black rounded-2xl text-xs uppercase tracking-widest"
                        >Coba Lagi</button
                    >
                </div>
            </div>

            <!-- Footer Controls -->
            <div class="p-8 bg-white/2 flex flex-col gap-4">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-3 h-3 bg-blue-500 rounded-full animate-pulse shadow-[0_0_10px_rgba(59,130,246,0.5)]"
                        >
                        </div>
                        <span
                            id="scanner-status"
                            class="text-[10px] font-black uppercase text-slate-400 tracking-widest"
                            >Siap memindai</span
                        >
                    </div>
                    <button
                        id="switch-camera"
                        class="p-3 bg-white/5 hover:bg-white/10 rounded-2xl text-white transition-all border border-white/5 cursor-pointer"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M11 19a2 2 0 1 0-2 2h2v-2Z"></path><path
                                d="M21 15V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10"
                            ></path><path
                                d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L12.172 15"
                            ></path><circle cx="9" cy="11" r="2"></circle></svg
                        >
                    </button>
                </div>

                <div class="flex gap-3">
                    <a
                        href="/dashboard"
                        class="flex-1 px-6 py-4 bg-white/5 hover:bg-white/10 text-white rounded-2xl font-bold text-center transition-all cursor-pointer"
                        >Kembali</a
                    >
                    <button
                        id="manual-btn"
                        class="flex-1 px-6 py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black shadow-xl shadow-blue-600/20 transition-all cursor-pointer"
                        >Input Manual</button
                    >
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Input Modal -->
    <dialog
        id="manual-modal"
        class="bg-slate-900 text-white border border-white/10 rounded-[2.5rem] p-10 backdrop:bg-slate-950/80 w-full max-w-sm shadow-2xl"
    >
        <h3 class="text-2xl font-black mb-6 uppercase tracking-tight">
            Input Token
        </h3>
        <p class="text-slate-500 text-xs mb-6 italic">
            Masukkan token yang tertera di layar depan jika kamera tidak
            berfungsi.
        </p>
        <div class="space-y-4">
            <input
                type="text"
                id="manual-token"
                placeholder="Contoh: 8xjs29ks"
                class="w-full bg-slate-800 border border-white/10 rounded-2xl px-6 py-4 text-white focus:ring-2 focus:ring-blue-500/50 outline-none transition-all uppercase font-mono"
            />
            <button
                id="submit-token"
                class="w-full px-6 py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black transition-all cursor-pointer"
                >Check-In</button
            >
            <button
                onclick="document.getElementById('manual-modal').close()"
                class="w-full px-6 py-4 bg-white/5 hover:bg-white/10 text-slate-400 rounded-2xl font-medium transition-all cursor-pointer"
                >Tutup</button
            >
        </div>
    </dialog>
</Layout>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    // @ts-ignore
    const html5QrCode = new Html5Qrcode("reader");
    let scanning = false;

    async function startScanner() {
        if (scanning) return;

        try {
            // @ts-ignore
            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length > 0) {
                // Default to back camera
                let cameraId = cameras[0].id;
                for (let cam of cameras) {
                    if (
                        cam.label.toLowerCase().includes("back") ||
                        cam.label.toLowerCase().includes("rear")
                    ) {
                        cameraId = cam.id;
                        break;
                    }
                }

                await html5QrCode.start(
                    cameraId,
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                    },
                    (decodedText: string) => {
                        // Success!
                        if (decodedText.includes("/attendance/scan?token=")) {
                            scanning = false;
                            html5QrCode.stop();
                            window.location.href = decodedText;
                        } else {
                            // Maybe it's just the token
                            const token = decodedText.trim();
                            if (
                                token.length > 5 &&
                                token.length < 20 &&
                                !token.includes(" ")
                            ) {
                                scanning = false;
                                html5QrCode.stop();
                                window.location.href = `/attendance/scan?token=${token}`;
                            }
                        }
                    },
                    (errorMessage: string) => {
                        // skip errors
                    },
                );
                scanning = true;
            } else {
                showCameraError();
            }
        } catch (err) {
            console.error(err);
            showCameraError();
        }
    }

    function showCameraError() {
        document.getElementById("camera-error")?.classList.remove("hidden");
        document.getElementById("scanner-overlay")?.classList.add("hidden");
    }

    // Controls
    document.getElementById("manual-btn")?.addEventListener("click", () => {
        (
            document.getElementById("manual-modal") as HTMLDialogElement
        ).showModal();
    });

    document.getElementById("submit-token")?.addEventListener("click", () => {
        const token = (
            document.getElementById("manual-token") as HTMLInputElement
        ).value.trim();
        if (token) {
            window.location.href = `/attendance/scan?token=${token}`;
        }
    });

    document
        .getElementById("switch-camera")
        ?.addEventListener("click", async () => {
            if (scanning) {
                await html5QrCode.stop();
                scanning = false;
                // Simply restart and it might pick next camera in a more advanced implementation,
                // but for simplicity we just toggle or restart.
                startScanner();
            }
        });

    // Start on load
    startScanner();

    // Clean up on page leave
    window.addEventListener("beforeunload", () => {
        if (scanning) {
            html5QrCode.stop();
        }
    });
</script>

<style>
    @keyframes scan {
        0%,
        100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(256px);
        }
    }
    .animate-scan {
        animation: scan 2s linear infinite;
        border-bottom: 2px solid #3b82f6;
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.5);
    }
</style>
