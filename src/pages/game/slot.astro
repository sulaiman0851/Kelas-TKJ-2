---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Slot Gacor 99 - Kelas TKJ">
    <div
        class="relative min-h-[90vh] w-full flex flex-col items-center py-12 px-4 overflow-hidden"
    >
        <!-- Background Decoration -->
        <div class="absolute inset-0 -z-10 pointer-events-none">
            <div
                class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-600/10 blur-[120px] rounded-full animate-pulse"
            >
            </div>
            <div
                class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-blue-600/10 blur-[120px] rounded-full animate-pulse"
                style="animation-delay: 2s;"
            >
            </div>
        </div>

        <!-- Skeleton Loader (Centered) -->
        <div
            id="game-skeleton"
            class="w-full max-w-4xl space-y-8 animate-pulse"
        >
            <div
                class="flex flex-col md:flex-row justify-between items-center gap-6"
            >
                <div class="w-48 h-12 bg-white/5 rounded-2xl"></div>
                <div class="flex gap-4">
                    <div class="w-40 h-16 bg-white/5 rounded-2xl"></div>
                    <div class="w-32 h-16 bg-white/5 rounded-2xl"></div>
                </div>
            </div>
            <div
                class="w-full aspect-[4/3] max-h-[500px] bg-white/5 rounded-[3rem]"
            >
            </div>
            <div class="grid grid-cols-4 gap-4 w-full max-w-2xl mx-auto">
                <div class="h-24 bg-white/5 rounded-2xl"></div>
                <div class="h-24 bg-white/5 rounded-2xl"></div>
                <div class="h-24 bg-white/5 rounded-2xl"></div>
                <div class="h-24 bg-white/5 rounded-2xl"></div>
            </div>
        </div>

        <!-- Main Game Content (Centered) -->
        <div id="game-content" class="w-full max-w-4xl hidden opacity-0 transition-opacity duration-700 flex flex-col items-center">
            <!-- Header Stats -->
            <div class="w-full flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                <div class="flex items-center gap-4">
                    <a href="/dashboard" class="p-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl transition-all group">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="group-hover:-translate-x-1 transition-transform"><path d="m15 18-6-6 6-6"></path></svg>
                    </a>
                    <h1 class="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 tracking-tighter italic uppercase">Slot Gacor 99</h1>
                </div>

                <div class="flex items-center gap-3">
                    <div class="px-5 py-3 bg-slate-900 border border-white/10 rounded-2xl shadow-xl shadow-black/50">
                        <p class="text-[10px] font-black text-yellow-500 uppercase tracking-widest mb-0.5">Saldo</p>
                        <p class="text-xl font-mono font-bold text-white"><span class="text-yellow-500 mr-1">Rp</span><span id="display-balance">0</span></p>
                    </div>
                    <div class="px-5 py-3 bg-slate-900 border border-white/10 rounded-2xl shadow-xl shadow-black/50">
                        <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-0.5">Point</p>
                        <p class="text-xl font-mono font-bold text-white"><span class="text-emerald-500 mr-1">‚òÖ</span><span id="display-points">0</span></p>
                    </div>
                    <button id="btn-topup-trigger" class="p-4 bg-orange-600 hover:bg-orange-500 text-white rounded-2xl shadow-xl shadow-orange-600/20 transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Slot Machine Container -->
            <div class="relative w-full max-w-4xl bg-gradient-to-b from-slate-800 to-slate-950 p-6 md:p-8 rounded-[3rem] border-4 border-slate-700 shadow-[0_0_100px_rgba(0,0,0,0.6)] mb-12">
                <!-- Reels Grid -->
                <div class="grid grid-cols-3 gap-3 md:gap-6 bg-black/60 rounded-[2rem] border-2 border-slate-900 inner-shadow overflow-hidden h-64 md:h-[480px] relative" id="slot-machine-reels">
                    <!-- Winning Line -->
                    <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-0.5 bg-yellow-500/30 z-10 blur-[1px]"></div>
                    <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-16 bg-gradient-to-b from-transparent via-yellow-500/5 to-transparent z-0"></div>

                    <div class="reel-container h-full" id="reel-1">
                        <div class="reel-strip" id="strip-1"></div>
                    </div>
                    <div class="reel-container h-full" id="reel-2">
                        <div class="reel-strip" id="strip-2"></div>
                    </div>
                    <div class="reel-container h-full" id="reel-3">
                        <div class="reel-strip" id="strip-3"></div>
                    </div>
                </div>

                <!-- Game Controls -->
                <div class="flex flex-col md:flex-row gap-4 mt-8">
                    <div class="flex-1 bg-black/40 border border-white/5 rounded-[2rem] p-4 flex flex-col justify-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 text-center">Custom Taruhan</p>
                        <div class="flex items-center justify-between gap-4">
                            <button class="bet-adjust w-10 h-10 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-full text-white font-bold transition-all" data-amount="-500">-</button>
                            <div class="flex-1 text-center">
                                <input type="number" id="input-bet" class="w-full bg-transparent text-center text-2xl font-mono font-bold text-white outline-none" value="500" min="500" />
                                <div id="display-bet-rupiah" class="text-xs text-yellow-500 font-bold">Rp 500</div>
                            </div>
                            <button class="bet-adjust w-10 h-10 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-full text-white font-bold transition-all" data-amount="500">+</button>
                        </div>
                    </div>
                    <button id="btn-spin" class="flex-[1.5] py-6 bg-gradient-to-r from-red-600 via-orange-600 to-red-600 text-white font-black text-3xl tracking-widest rounded-[2rem] shadow-[0_12px_20px_rgba(220,38,38,0.2),inset_0_-8px_0_rgba(0,0,0,0.2)] hover:brightness-110 active:scale-95 transition-all uppercase italic">SPIN</button>
                </div>
                
                <button id="btn-tukar-poin" class="w-full mt-6 py-4 bg-emerald-600/10 hover:bg-emerald-600/20 text-emerald-400 border border-emerald-500/10 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all">Tukar Poin ke Saldo</button>
            </div>

            <!-- Paytable (Outside) -->
            <div class="w-full max-w-4xl grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-6 bg-slate-900 border border-white/5 rounded-[2rem] text-center shadow-xl">
                    <p class="text-4xl mb-2">üëë</p>
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">JACKPOT</p>
                    <p class="text-xl font-black text-yellow-500">100x</p>
                </div>
                <div class="p-6 bg-slate-900 border border-white/5 rounded-[2rem] text-center shadow-xl">
                    <p class="text-4xl mb-2">üíé</p>
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">DIAMOND</p>
                    <p class="text-xl font-black text-blue-400">20x</p>
                </div>
                <div class="p-6 bg-slate-900 border border-white/5 rounded-[2rem] text-center shadow-xl">
                    <p class="text-4xl mb-2">üçä</p>
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">FRUIT</p>
                    <p class="text-xl font-black text-orange-400">5x</p>
                </div>
                <div class="p-6 bg-slate-900 border border-white/5 rounded-[2rem] text-center shadow-xl">
                    <p class="text-4xl mb-2">üçí</p>
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">CHERRY</p>
                    <p class="text-xl font-black text-red-400">2x</p>
                </div>
            </div>
        </div>
    </div>
</Layout>

<!-- Result Modal (Hidden) -->
<div
    id="win-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-500"
>
    <div
        class="bg-slate-900 border-2 border-yellow-500/50 p-8 rounded-[3rem] text-center max-w-sm w-full relative overflow-hidden shadow-[0_0_50px_rgba(234,179,8,0.3)]"
    >
        <div id="modal-confetti" class="absolute inset-0 -z-10"></div>
        <h2
            id="win-status"
            class="text-4xl font-black text-yellow-500 italic mb-2"
        >
            WINNER!
        </h2>
        <p
            id="win-amount"
            class="text-5xl font-mono font-black text-white mb-6 tracking-tighter"
        >
            Rp 0
        </p>
        <p class="text-emerald-400 font-bold mb-8">
            + <span id="win-points">0</span> Points Earned!
        </p>
        <button
            id="close-modal"
            class="w-full py-4 bg-yellow-500 text-black font-black rounded-2xl text-lg uppercase tracking-widest hover:bg-yellow-400 transition-colors"
            >Klaim</button
        >
    </div>
</div>

<!-- Topup Modal -->
<div
    id="topup-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden"
>
    <div
        class="bg-slate-900 border border-white/10 p-8 rounded-[2.5rem] max-w-md w-full"
    >
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-black italic">TOP UP SALDO</h3>
            <button id="close-topup" class="text-slate-500 hover:text-white"
                >‚úï</button
            >
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button
                type="button"
                class="preset-topup p-4 bg-slate-800 border-2 border-white/5 rounded-2xl hover:border-orange-500/50 transition-all font-mono font-bold cursor-pointer active:scale-95 text-white"
                data-amount="50000">Rp 50rb</button
            >
            <button
                type="button"
                class="preset-topup p-4 bg-slate-800 border-2 border-white/5 rounded-2xl hover:border-orange-500/50 transition-all font-mono font-bold cursor-pointer active:scale-95 text-white"
                data-amount="100000">Rp 100rb</button
            >
            <button
                type="button"
                class="preset-topup p-4 bg-slate-800 border-2 border-white/5 rounded-2xl hover:border-orange-500/50 transition-all font-mono font-bold cursor-pointer active:scale-95 text-white"
                data-amount="250000">Rp 250rb</button
            >
            <button
                type="button"
                class="preset-topup p-4 bg-slate-800 border-2 border-white/5 rounded-2xl hover:border-orange-500/50 transition-all font-mono font-bold cursor-pointer active:scale-95 text-white"
                data-amount="500000">Rp 500rb</button
            >
        </div>
        <button
            id="btn-submit-topup"
            class="w-full py-4 bg-orange-600 text-white font-black rounded-2xl text-lg uppercase tracking-widest hover:bg-orange-500 disabled:opacity-50"
            >Kirim Permintaan</button
        >
        <p class="text-[10px] text-slate-500 text-center mt-4">
            Permintaan top up akan segera disetujui admin.
        </p>
    </div>
</div>

<style is:global>
    @keyframes pulse-soft {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
    .animate-pulse-soft {
        animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .inner-shadow {
        box-shadow: inset 0 10px 40px rgba(0, 0, 0, 0.8);
    }

    .reel-container {
        height: 100%;
        position: relative;
        border-right: 2px solid rgba(255, 255, 255, 0.05);
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.2),
            transparent 20%,
            transparent 80%,
            rgba(0, 0, 0, 0.2)
        );
    }
    .reel-container:last-child {
        border-right: none;
    }

    .reel-strip {
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
        transition: transform 3s cubic-bezier(0.45, 0.05, 0.55, 0.95);
    }

    .symbol {
        height: var(--item-height, 150px);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: min(100px, 12cqh); 
        line-height: 1 !important;
        filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
        user-select: none;
        padding: 0;
        margin: 0;
        flex-shrink: 0;
        transition: opacity 0.5s;
    }

    /* Darken non-winning rows to make results pop */
    .reel-strip .symbol:not(.is-winner) {
        opacity: 0.6;
    }
    .reel-strip .symbol.is-winner {
        opacity: 1;
        transform: scale(1.1);
        z-index: 10;
        filter: drop-shadow(0 0 15px rgba(234, 179, 8, 0.4));
    }

    /* Desktop adjustments */
    @media (min-width: 768px) {
        .symbol {
            font-size: min(140px, 15cqh);
        }
    }
</style>

<script>
    import { supabase } from "../../lib/supabase";

    const SYMBOLS = ["üëë", "üíé", "üçä", "üçí", "üçã", "üîî", "7Ô∏è‚É£"];
    
    // Pita gulungan tetap (Reel Strips) agar terlihat pro dan konsisten
    const REEL_STRIPS = [
        [...SYMBOLS, ...SYMBOLS, ...SYMBOLS, ...SYMBOLS, ...SYMBOLS].sort(() => Math.random() - 0.5),
        [...SYMBOLS, ...SYMBOLS, ...SYMBOLS, ...SYMBOLS, ...SYMBOLS].sort(() => Math.random() - 0.5),
        [...SYMBOLS, ...SYMBOLS, ...SYMBOLS, ...SYMBOLS, ...SYMBOLS].sort(() => Math.random() - 0.5)
    ];

    let currentPositions = [0, 0, 0]; // Index simbol tengah saat ini

    let REEL_HEIGHT = 450;
    let ITEM_HEIGHT = 150;

    function updateReelHeight() {
        const container = document.getElementById("slot-machine-reels");
        if (container) {
            const h = container.clientHeight;
            if (h > 0) {
                REEL_HEIGHT = h;
                ITEM_HEIGHT = h / 3;
                document.documentElement.style.setProperty("--reel-height", `${REEL_HEIGHT}px`);
                document.documentElement.style.setProperty("--item-height", `${ITEM_HEIGHT}px`);
            }
        }
    }

    const SYMBOL_HEIGHT = 200; // Visual height for the reels animation

    let wallet: any = { balance: 0, points: 0 };
    let slotSettings: any = {
        hoki_percentage: 30,
        point_per_game: 10,
        point_exchange_rate: 100,
    };
    let currentBet = 500;
    let isSpinning = false;

    async function init() {
        const {
            data: { session },
        } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = "/login";
            return;
        }

        // Load Wallet
        const { data: w } = await supabase
            .from("user_wallets")
            .select("*")
            .eq("user_id", session.user.id)
            .single();
        if (w) {
            wallet = w;
            updateDisplays();
        }

        // Load Settings
        const { data: s } = await supabase
            .from("slot_settings")
            .select("*")
            .eq("id", 1)
            .single();
        if (s) slotSettings = s;

        updateReelHeight(); // Harus dipanggil sebelum setupReels agar REEL_HEIGHT akurat
        setupReels();
        setupEventListeners();
        window.addEventListener("resize", updateReelHeight);

        // Hide Skeleton & Show Content
        const skeleton = document.getElementById("game-skeleton");
        const content = document.getElementById("game-content");

        if (skeleton) skeleton.classList.add("hidden");
        if (content) {
            content.classList.remove("hidden");
            setTimeout(() => {
                content.classList.remove("opacity-0");
                content.classList.add("opacity-100");
            }, 50);
        }
    }

    function setupReels() {
        for (let i = 1; i <= 3; i++) {
            const strip = document.getElementById(`strip-${i}`);
            if (!strip) continue;

            strip.innerHTML = "";
            const reelData = REEL_STRIPS[i-1];
            const pos = currentPositions[i-1];

            // Tampilkan 3 simbol dari pita gulungan: [pos-1, pos, pos+1]
            for (let j = -1; j <= 1; j++) {
                const idx = (pos + j + reelData.length) % reelData.length;
                const div = document.createElement("div");
                div.className = "symbol" + (j === 0 ? " is-winner" : "");
                div.style.height = `${ITEM_HEIGHT}px`;
                div.textContent = reelData[idx];
                strip.appendChild(div);
            }
        }
    }

    function formatRupiah(amount: number) {
        return new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        }).format(amount);
    }

    function updateDisplays() {
        const balanceEl = document.getElementById("display-balance");
        const pointsEl = document.getElementById("display-points");
        if (balanceEl)
            balanceEl.innerText = Number(wallet.balance).toLocaleString(
                "id-ID",
                { minimumFractionDigits: 2 },
            );
        if (pointsEl)
            pointsEl.innerText = Number(wallet.points).toLocaleString("id-ID");

        const betInput = document.getElementById(
            "input-bet",
        ) as HTMLInputElement;
        const betRupiah = document.getElementById("display-bet-rupiah");
        if (betInput) betInput.value = currentBet.toString();
        if (betRupiah) betRupiah.innerText = formatRupiah(currentBet);
    }

    function setupEventListeners() {
        document.getElementById("btn-spin")?.addEventListener("click", spin);

        const betInput = document.getElementById(
            "input-bet",
        ) as HTMLInputElement;
        betInput?.addEventListener("change", (e) => {
            currentBet = Math.max(
                500,
                parseInt((e.target as HTMLInputElement).value) || 500,
            );
            updateDisplays();
        });

        document.querySelectorAll(".bet-adjust").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const amount = parseInt(
                    (e.currentTarget as HTMLElement).dataset.amount || "0",
                );
                currentBet = Math.max(500, currentBet + amount);
                updateDisplays();
            });
        });

        // Topup Modal
        const topupTrigger = document.getElementById("btn-topup-trigger");
        const topupModal = document.getElementById("topup-modal");
        const closeTopup = document.getElementById("close-topup");

        topupTrigger?.addEventListener("click", () =>
            topupModal?.classList.remove("hidden"),
        );
        closeTopup?.addEventListener("click", () =>
            topupModal?.classList.add("hidden"),
        );

        let selectedTopup: number | null = null;
        document.querySelectorAll(".preset-topup").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const target = e.currentTarget as HTMLElement;
                document.querySelectorAll(".preset-topup").forEach((b) => {
                    b.classList.remove(
                        "border-orange-500",
                        "bg-orange-500/20",
                        "ring-2",
                        "ring-orange-500/50",
                    );
                    b.classList.add("border-white/5", "bg-slate-800");
                });

                target.classList.remove("border-white/5", "bg-slate-800");
                target.classList.add(
                    "border-orange-500",
                    "bg-orange-500/20",
                    "ring-2",
                    "ring-orange-500/50",
                );

                selectedTopup = parseInt(target.dataset.amount || "0");
                console.log("Selected topup:", selectedTopup);
            });
        });

        document
            .getElementById("btn-submit-topup")
            ?.addEventListener("click", async () => {
                if (!selectedTopup) {
                    alert("Pilih nominal top up!");
                    return;
                }

                const submitBtn = document.getElementById(
                    "btn-submit-topup",
                ) as HTMLButtonElement;
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerText = "Mengirim...";
                }

                try {
                    const {
                        data: { session },
                    } = await supabase.auth.getSession();

                    if (!session) {
                        alert("Anda harus login terlebih dahulu!");
                        return;
                    }

                    const { error } = await supabase
                        .from("topup_history")
                        .insert({
                            user_id: session.user.id,
                            amount: selectedTopup,
                            status: "pending",
                        });

                    if (error) {
                        console.error("Topup error:", error);
                        alert(
                            "Gagal mengirim permintaan top up: " +
                                error.message,
                        );
                    } else {
                        alert(
                            "Permintaan top up berhasil dikirim! Silahkan hubungi admin untuk aktivasi.",
                        );
                        // Reset selection
                        document
                            .querySelectorAll(".preset-topup")
                            .forEach((b) =>
                                b.classList.remove(
                                    "border-orange-500",
                                    "bg-orange-500/10",
                                ),
                            );
                        selectedTopup = null;
                        document
                            .getElementById("topup-modal")
                            ?.classList.add("hidden");
                    }
                } catch (err) {
                    console.error("Topup exception:", err);
                    alert("Terjadi kesalahan saat mengirim permintaan");
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerText = "Kirim Permintaan";
                    }
                }
            });

        // Modal close
        document
            .getElementById("close-modal")
            ?.addEventListener("click", () => {
                const modal = document.getElementById("win-modal");
                modal?.classList.add("hidden");
                modal?.classList.remove("opacity-100");
            });

        // Tukar Poin
        document
            .getElementById("btn-tukar-poin")
            ?.addEventListener("click", async () => {
                if (wallet.points < slotSettings.point_exchange_rate) {
                    alert(
                        `Minimal penukaran ${slotSettings.point_exchange_rate} poin!`,
                    );
                    return;
                }

                const amountToExchange = Math.floor(
                    wallet.points / slotSettings.point_exchange_rate,
                );
                const pointsToDeduct =
                    amountToExchange * slotSettings.point_exchange_rate;
                const balanceToAdd = amountToExchange; // 100 points = Rp 1 (Or whatever logic)

                const {
                    data: { session },
                } = await supabase.auth.getSession();
                if (!session) return;

                const { error } = await supabase
                    .from("user_wallets")
                    .update({
                        points: wallet.points - pointsToDeduct,
                        balance: Number(wallet.balance) + balanceToAdd,
                    })
                    .eq("user_id", session.user.id);

                if (!error) {
                    wallet.points -= pointsToDeduct;
                    wallet.balance = Number(wallet.balance) + balanceToAdd;
                    updateDisplays();

                    await supabase.from("point_history").insert({
                        user_id: session.user.id,
                        amount: -pointsToDeduct,
                        type: "exchange",
                        description: `Tukar poin ke saldo Rp ${balanceToAdd}`,
                    });

                    alert("Berhasil menukar poin!");
                }
            });
    }

    async function spin() {
        if (isSpinning) return;
        if (wallet.balance < currentBet) {
            alert("Saldo tidak cukup!");
            return;
        }

        const {
            data: { session },
        } = await supabase.auth.getSession();
        if (!session) return;

        isSpinning = true;
        const spinBtn = document.getElementById("btn-spin");
        if (spinBtn) spinBtn.setAttribute("disabled", "true");

        // Deduct Balance
        const { error: deductErr } = await supabase
            .from("user_wallets")
            .update({
                balance: Number(wallet.balance) - currentBet,
            })
            .eq("user_id", session.user.id);

        if (deductErr) {
            alert("Gagal memulai permainan");
            isSpinning = false;
            if (spinBtn) spinBtn.removeAttribute("disabled");
            return;
        }

        wallet.balance = Number(wallet.balance) - currentBet;
        updateDisplays();

        // Determine Result (Client-side simulation of Hoki Percentage)
        const luck = Math.random() * 100;
        const isWin = luck <= slotSettings.hoki_percentage;

        let resultSymbols = [];
        if (isWin) {
            // Pick a winning symbol
            const winner = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
            resultSymbols = [winner, winner, winner];
        } else {
            // Random non-winning symbols
            while (true) {
                resultSymbols = [
                    SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                    SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                    SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                ];
                if (
                    resultSymbols[0] !== resultSymbols[1] ||
                    resultSymbols[1] !== resultSymbols[2]
                )
                    break;
            }
        }

        // Animation Logic: Rolling the fixed strips
        const ROUNDS = 5; // Putar pita sebanyak 5 kali agar banter

        const nextPositions = [0, 0, 0];

        for (let i = 1; i <= 3; i++) {
            const strip = document.getElementById(`strip-${i}`);
            if (!strip) continue;

            const reelData = REEL_STRIPS[i-1];
            const currentPos = currentPositions[i-1];
            
            // Cari index simbol hasil di dalam pita gulungan
            // Kita cari index secara acak dari simbol tersebut agar tidak ketebak
            const possibleIndices = reelData.map((s, idx) => s === resultSymbols[i-1] ? idx : -1).filter(idx => idx !== -1);
            const targetIdx = possibleIndices[Math.floor(Math.random() * possibleIndices.length)];
            nextPositions[i-1] = targetIdx;

            // Bersihkan strip dan isi dengan urutan pita dari current ke target
            strip.innerHTML = "";
            
            // Start Symbols (3 yang terlihat sekarang)
            for (let j = -1; j <= 1; j++) {
                const idx = (currentPos + j + reelData.length) % reelData.length;
                const div = document.createElement("div");
                div.className = "symbol";
                div.style.height = `${ITEM_HEIGHT}px`;
                div.textContent = reelData[idx];
                strip.appendChild(div);
            }

            // Filler Symbols (Pita yang berputar)
            let totalFillerIcons = 0;
            for (let r = 0; r < ROUNDS; r++) {
                for (let s = 0; s < reelData.length; s++) {
                    const div = document.createElement("div");
                    div.className = "symbol";
                    div.style.height = `${ITEM_HEIGHT}px`;
                    div.textContent = reelData[s];
                    strip.appendChild(div);
                    totalFillerIcons++;
                }
            }

            // Target Symbols (Result and neighbors)
            for (let j = -1; j <= 1; j++) {
                const idx = (targetIdx + j + reelData.length) % reelData.length;
                const div = document.createElement("div");
                div.className = "symbol" + (j === 0 ? " result-tag" : ""); 
                div.style.height = `${ITEM_HEIGHT}px`;
                div.textContent = reelData[idx];
                strip.appendChild(div);
            }

            // Calculate exact Y to center the resultIdx
            // 3 icons are at the start, then totalFillerIcons, then the 3 target icons.
            // Result is the 2nd icon of the target set.
            const targetIconIndex = 3 + totalFillerIcons + 1; 
            const finalY = (targetIconIndex * ITEM_HEIGHT) - ITEM_HEIGHT;

            strip.style.transition = `transform ${3 + i * 0.7}s cubic-bezier(0.15, 0, 0.05, 1)`;
            strip.style.transform = `translateY(-${finalY}px)`;
        }

        currentPositions = [...nextPositions];

        // Wait for animation
        setTimeout(async () => {
            isSpinning = false;
            if (spinBtn) spinBtn.removeAttribute("disabled");

            const winMultiplier: Record<string, number> = {
                "üëë": 100,
                "üíé": 20,
                "üçä": 5,
                "üçí": 2,
                "üçã": 1.5,
                "üîî": 1.2,
                "7Ô∏è‚É£": 1.1,
            };

            if (isWin) {
                const symbol = resultSymbols[0];
                const winAmount = currentBet * (winMultiplier[symbol] || 1);
                const winPoints = slotSettings.point_per_game;

                const { error: winErr } = await supabase
                    .from("user_wallets")
                    .update({
                        balance: Number(wallet.balance) + winAmount,
                        points: Number(wallet.points) + winPoints,
                    })
                    .eq("user_id", session.user.id);

                if (!winErr) {
                    wallet.balance = Number(wallet.balance) + winAmount;
                    wallet.points = Number(wallet.points) + winPoints;
                    updateDisplays();
                    showWinModal(winAmount, winPoints);
                }
            } else {
                // Even if lose, maybe get small points?
                const losePoints = 1;
                const { error: pointErr } = await supabase
                    .from("user_wallets")
                    .update({
                        points: Number(wallet.points) + losePoints,
                    })
                    .eq("user_id", session.user.id);

                if (!pointErr) {
                    wallet.points = Number(wallet.points) + losePoints;
                    updateDisplays();
                }
            }

            // Reset strips dengan pita gulungan tetap (Smooth transition)
            for (let i = 1; i <= 3; i++) {
                const strip = document.getElementById(`strip-${i}`);
                if (!strip) continue;

                strip.style.transition = "none";
                strip.style.transform = "translateY(0)";

                const reelData = REEL_STRIPS[i-1];
                const pos = currentPositions[i-1];

                strip.innerHTML = "";
                // Urutan pita gulungan: [pos-1, pos, pos+1]
                for (let j = -1; j <= 1; j++) {
                    const idx = (pos + j + reelData.length) % reelData.length;
                    const div = document.createElement("div");
                    div.className = "symbol" + (j === 0 ? " is-winner" : "");
                    div.style.height = `${ITEM_HEIGHT}px`;
                    div.textContent = reelData[idx];
                    strip.appendChild(div);
                }
            }
        }, 5000);
    }

    function showWinModal(amount: number, points: number) {
        const modal = document.getElementById("win-modal");
        const amountEl = document.getElementById("win-amount");
        const pointsEl = document.getElementById("win-points");

        if (amountEl)
            amountEl.innerText = `Rp ${amount.toLocaleString("id-ID")}`;
        if (pointsEl) pointsEl.innerText = points.toString();

        modal?.classList.remove("hidden");
        setTimeout(() => modal?.classList.add("opacity-100"), 10);
    }

    init();
</script>
