---
import Layout from "../layouts/Layout.astro";
export const prerender = false;
---

<Layout title="Random Team Generator - XII TKJ 2">
    <div class="relative min-h-screen pt-20 pb-12 px-4">
        <!-- Background Elements -->
        <div class="fixed inset-0 pointer-events-none overflow-hidden -z-10">
            <div
                class="absolute top-[10%] left-[5%] w-[500px] h-[500px] bg-blue-600/10 rounded-full blur-[120px] animate-pulse"
            >
            </div>
            <div
                class="absolute bottom-[10%] right-[5%] w-[500px] h-[500px] bg-purple-600/10 rounded-full blur-[120px] animate-pulse"
                style="animation-delay: 2s"
            >
            </div>
        </div>

        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <header class="text-center mb-12">
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 backdrop-blur-sm mb-6"
                >
                    <span class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"
                    ></span>
                    <span
                        class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]"
                        >Utility Tools</span
                    >
                </div>
                <h1
                    class="text-5xl md:text-7xl font-black text-white mb-4 tracking-tighter"
                >
                    RANDOM <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600"
                        >TEAM</span
                    >
                </h1>
                <p class="text-slate-400 text-lg max-w-2xl mx-auto">
                    Bagi kelas menjadi beberapa tim secara adil dan acak
                    menggunakan data student directory.
                </p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Configuration Sidebar -->
                <div class="lg:col-span-4 space-y-6">
                    <div
                        class="bg-slate-900/50 border border-white/5 rounded-[2.5rem] p-8 backdrop-blur-xl shadow-2xl"
                    >
                        <h2
                            class="text-xl font-bold text-white mb-6 flex items-center gap-3"
                        >
                            <span
                                class="p-2 bg-blue-500/20 rounded-xl text-blue-400"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"
                                    ></path><path
                                        d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"
                                    ></path><path d="M12 2v2"></path><path
                                        d="M12 20v2"></path><path
                                        d="m4.93 4.93 1.41 1.41"></path><path
                                        d="m17.66 17.66 1.41 1.41"></path><path
                                        d="M2 12h2"></path><path d="M20 12h2"
                                    ></path><path d="m6.34 17.66-1.41 1.41"
                                    ></path><path d="m19.07 4.93-1.41 1.41"
                                    ></path></svg
                                >
                            </span>
                            Konfigurasi
                        </h2>

                        <div class="space-y-6">
                            <div>
                                <label
                                    class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3"
                                    >Metode Pembagian</label
                                >
                                <div
                                    class="grid grid-cols-2 gap-2 bg-slate-950/50 p-1.5 rounded-2xl border border-white/5"
                                >
                                    <button
                                        id="btn-mode-count"
                                        class="px-4 py-3 rounded-xl text-xs font-bold transition-all bg-blue-600 text-white shadow-lg shadow-blue-600/20"
                                    >
                                        Jumlah Tim
                                    </button>
                                    <button
                                        id="btn-mode-size"
                                        class="px-4 py-3 rounded-xl text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-white/5"
                                    >
                                        Anggota / Tim
                                    </button>
                                </div>
                            </div>

                            <div id="input-group">
                                <label
                                    id="input-label"
                                    class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3"
                                    >Jumlah Tim yang diinginkan</label
                                >
                                <div class="relative">
                                    <input
                                        type="number"
                                        id="team-value"
                                        min="2"
                                        value="2"
                                        class="w-full bg-slate-950/50 border border-white/10 rounded-2xl px-6 py-4 text-xl font-bold text-white focus:outline-none focus:border-blue-500/50 transition-colors"
                                    />
                                    <div
                                        class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-600 font-bold uppercase text-[10px] tracking-widest pointer-events-none"
                                    >
                                        Value
                                    </div>
                                </div>
                            </div>

                            <div class="pt-4">
                                <button
                                    id="btn-generate"
                                    class="w-full group relative px-8 py-5 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 font-black uppercase tracking-widest text-sm overflow-hidden transition-all hover:scale-[1.02] hover:shadow-2xl hover:shadow-blue-500/25 active:scale-95"
                                >
                                    <span
                                        class="relative z-10 flex items-center justify-center gap-3"
                                    >
                                        ACAK TIM SEKARANG
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="18"
                                            height="18"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="3"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="animate-spin-slow"
                                            ><path
                                                d="M21 12a9 9 0 1 1-6.219-8.56"
                                            ></path></svg
                                        >
                                    </span>
                                    <div
                                        class="absolute inset-0 bg-gradient-to-r from-blue-400 to-purple-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-slate-900/50 border border-white/5 rounded-[2.5rem] p-8 backdrop-blur-xl shadow-2xl"
                    >
                        <div class="flex justify-between items-center mb-6">
                            <h2
                                class="text-xl font-bold text-white flex items-center gap-3"
                            >
                                <span
                                    class="p-2 bg-emerald-500/20 rounded-xl text-emerald-400"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2.5"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><path d="m21 17-2 2 2 2"></path><path
                                            d="M21 9-2 2 2 2"></path><path
                                            d="M21 13H3"></path><path
                                            d="M3 17h12"></path><path
                                            d="M3 9h12"></path></svg
                                    >
                                </span>
                                Pilih Siswa
                            </h2>
                            <div
                                class="text-[10px] font-black text-slate-500 uppercase tracking-widest"
                            >
                                <span id="selected-count">0</span> / <span
                                    id="total-count">0</span
                                >
                            </div>
                        </div>

                        <div class="flex gap-2 mb-4">
                            <button
                                id="btn-select-all"
                                class="flex-1 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all"
                                >Pilih Semua</button
                            >
                            <button
                                id="btn-deselect-all"
                                class="flex-1 px-4 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 text-[10px] font-black uppercase tracking-widest transition-all"
                                >Reset</button
                            >
                        </div>

                        <div
                            id="student-selector"
                            class="space-y-2 max-h-[400px] overflow-y-auto pr-2 no-scrollbar"
                        >
                            <!-- Loaded via JS -->
                            <div class="animate-pulse space-y-2">
                                {
                                    [1, 2, 3, 4, 5].map(() => (
                                        <div class="h-12 bg-white/5 rounded-2xl w-full" />
                                    ))
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Area -->
                <div class="lg:col-span-8">
                    <div
                        id="results-placeholder"
                        class="h-full min-h-[500px] flex flex-col items-center justify-center bg-slate-900/30 border-2 border-dashed border-white/5 rounded-[3rem] p-12 text-center"
                    >
                        <div
                            class="w-24 h-24 rounded-3xl bg-white/5 flex items-center justify-center mb-8 rotate-12 group-hover:rotate-0 transition-transform"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="48"
                                height="48"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="white"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                class="opacity-20"
                                ><path d="M12 3v18"></path><path
                                    d="m19 9-7 7-7-7"></path></svg
                            >
                        </div>
                        <h3
                            class="text-2xl font-black text-white/40 uppercase tracking-widest"
                        >
                            Siap Diacak?
                        </h3>
                        <p class="text-slate-600 max-w-xs mx-auto mt-4">
                            Konfigurasi pembagian tim di sebelah kiri, lalu
                            tekan tombol acak untuk melihat hasil.
                        </p>
                    </div>

                    <div
                        id="results-container"
                        class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-700"
                    >
                        <div class="flex justify-between items-end mb-4">
                            <h2
                                class="text-3xl font-black text-white italic tracking-tight flex items-center gap-4"
                            >
                                <span
                                    class="w-3 h-10 bg-gradient-to-b from-blue-500 to-purple-500 rounded-full"
                                ></span>
                                HASIL PEMBAGIAN TIM
                            </h2>
                            <button
                                id="btn-copy"
                                class="px-6 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2.5"
                                    ><rect
                                        width="14"
                                        height="14"
                                        x="8"
                                        y="8"
                                        rx="2"
                                        ry="2"></rect><path
                                        d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"
                                    ></path></svg
                                >
                                Salin Hasil
                            </button>
                        </div>
                        <div
                            id="teams-grid"
                            class="grid grid-cols-1 md:grid-cols-2 gap-6"
                        >
                            <!-- Results will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    @reference "../styles/global.css";
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .animate-spin-slow {
        animation: spin 3s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .team-card {
        @apply bg-slate-900 border border-white/5 rounded-[2.5rem] p-8 relative overflow-hidden transition-all duration-500 hover:shadow-2xl hover:border-white/10;
    }

    .team-card::before {
        content: "";
        @apply absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-16 -mt-16 blur-3xl transition-opacity;
    }
</style>

<script>
    import { supabase } from "../lib/supabase";

    let students: any[] = [];
    let selectedStudentIds: Set<number> = new Set();
    let mode: "count" | "size" = "count";

    async function init() {
        const { data: list } = await supabase
            .from("student_directory")
            .select("*")
            .order("absent_no", { ascending: true });

        students = list || [];
        students.forEach((s) => selectedStudentIds.add(s.id));

        renderSelectors();
        updateStats();
        setupEventListeners();
    }

    function updateStats() {
        const selectedEl = document.getElementById("selected-count");
        const totalEl = document.getElementById("total-count");
        if (selectedEl)
            selectedEl.innerText = selectedStudentIds.size.toString();
        if (totalEl) totalEl.innerText = students.length.toString();
    }

    function renderSelectors() {
        const container = document.getElementById("student-selector");
        if (!container) return;

        container.innerHTML = students
            .map(
                (s) => `
            <div 
                onclick="toggleStudent(${s.id})"
                data-id="${s.id}"
                class="student-item group flex items-center gap-4 p-4 bg-slate-950/40 border border-white/5 rounded-2xl cursor-pointer hover:border-blue-500/30 transition-all ${selectedStudentIds.has(s.id) ? "bg-blue-600/10 border-blue-500/30 ring-1 ring-blue-500/20" : "opacity-40 grayscale"}"
            >
                <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-slate-900 border border-white/10 text-[10px] font-black text-slate-500 group-hover:text-blue-400 transition-colors">
                    ${String(s.absent_no).padStart(2, "0")}
                </div>
                <div class="flex-1">
                    <div class="text-sm font-bold text-white uppercase tracking-tight line-clamp-1">${s.full_name}</div>
                </div>
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${selectedStudentIds.has(s.id) ? "bg-blue-500 border-blue-500" : "border-white/10"}">
                    ${selectedStudentIds.has(s.id) ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' : ""}
                </div>
            </div>
        `,
            )
            .join("");
    }

    (window as any).toggleStudent = (id: number) => {
        if (selectedStudentIds.has(id)) {
            selectedStudentIds.delete(id);
        } else {
            selectedStudentIds.add(id);
        }
        renderSelectors();
        updateStats();
    };

    function setupEventListeners() {
        // Mode Toggles
        const btnCount = document.getElementById("btn-mode-count");
        const btnSize = document.getElementById("btn-mode-size");
        const inputLabel = document.getElementById("input-label");

        btnCount?.addEventListener("click", () => {
            mode = "count";
            btnCount.classList.add(
                "bg-blue-600",
                "text-white",
                "shadow-lg",
                "shadow-blue-600/20",
            );
            btnCount.classList.remove("text-slate-400");
            btnSize?.classList.remove(
                "bg-blue-600",
                "text-white",
                "shadow-lg",
                "shadow-blue-600/20",
            );
            btnSize?.classList.add("text-slate-400");
            if (inputLabel) inputLabel.innerText = "Jumlah Tim yang diinginkan";
        });

        btnSize?.addEventListener("click", () => {
            mode = "size";
            btnSize.classList.add(
                "bg-blue-600",
                "text-white",
                "shadow-lg",
                "shadow-blue-600/20",
            );
            btnSize.classList.remove("text-slate-400");
            btnCount?.classList.remove(
                "bg-blue-600",
                "text-white",
                "shadow-lg",
                "shadow-blue-600/20",
            );
            btnCount?.classList.add("text-slate-400");
            if (inputLabel) inputLabel.innerText = "Jumlah Anggota per Tim";
        });

        // Bulk Selection
        document
            .getElementById("btn-select-all")
            ?.addEventListener("click", () => {
                students.forEach((s) => selectedStudentIds.add(s.id));
                renderSelectors();
                updateStats();
            });

        document
            .getElementById("btn-deselect-all")
            ?.addEventListener("click", () => {
                selectedStudentIds.clear();
                renderSelectors();
                updateStats();
            });

        // Generate
        document
            .getElementById("btn-generate")
            ?.addEventListener("click", generateTeams);

        // Copy
        document
            .getElementById("btn-copy")
            ?.addEventListener("click", copyResults);
    }

    function generateTeams() {
        if (selectedStudentIds.size < 2) {
            alert("Pilih minimal 2 siswa!");
            return;
        }

        const value = parseInt(
            (document.getElementById("team-value") as HTMLInputElement).value,
        );
        if (!value || value < 1) {
            alert("Masukkan nilai yang valid!");
            return;
        }

        const selectedStudents = students.filter((s) =>
            selectedStudentIds.has(s.id),
        );
        const shuffled = [...selectedStudents].sort(() => Math.random() - 0.5);

        let teams: any[][] = [];

        if (mode === "count") {
            const teamCount = Math.min(value, shuffled.length);
            for (let i = 0; i < teamCount; i++) teams.push([]);
            shuffled.forEach((student, index) => {
                teams[index % teamCount].push(student);
            });
        } else {
            const teamSize = Math.min(value, shuffled.length);
            const teamCount = Math.ceil(shuffled.length / teamSize);
            for (let i = 0; i < teamCount; i++) {
                teams.push(shuffled.slice(i * teamSize, (i + 1) * teamSize));
            }
        }

        renderResults(teams);
    }

    function renderResults(teams: any[][]) {
        const placeholder = document.getElementById("results-placeholder");
        const container = document.getElementById("results-container");
        const grid = document.getElementById("teams-grid");

        if (!placeholder || !container || !grid) return;

        placeholder.classList.add("hidden");
        container.classList.remove("hidden");

        grid.innerHTML = teams
            .map(
                (team, i) => `
            <div class="team-card animate-in fade-in slide-in-from-bottom-4 duration-500" style="animation-delay: ${i * 100}ms">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-[0.3em]">Team</span>
                        <h3 class="text-3xl font-black text-white italic tracking-tighter">${i + 1}</h3>
                    </div>
                    <div class="px-3 py-1 bg-white/5 border border-white/10 rounded-full text-[10px] font-black text-slate-500 uppercase">
                        ${team.length} Anggota
                    </div>
                </div>
                <div class="space-y-3">
                    ${team
                        .map(
                            (member) => `
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-2xl border border-white/5 group hover:border-white/20 hover:bg-white/10 transition-all">
                            <span class="text-[10px] font-mono text-slate-500 w-6">${String(member.absent_no).padStart(2, "0")}</span>
                            <span class="text-sm font-bold text-slate-200 uppercase tracking-tight group-hover:text-white transition-colors">${member.full_name}</span>
                        </div>
                    `,
                        )
                        .join("")}
                </div>
            </div>
        `,
            )
            .join("");

        container.scrollIntoView({ behavior: "smooth" });
    }

    function copyResults() {
        const cards = document.querySelectorAll(".team-card");
        if (cards.length === 0) return;

        let text = "*HASIL PEMBAGIAN TIM XII TKJ 2*\n\n";
        const teams = Array.from(cards).map((card, i) => {
            const nameElements = card.querySelectorAll(".text-sm");
            const members = Array.from(nameElements)
                .map((el) => el.textContent)
                .join("\n• ");
            return `*TIM ${i + 1}*\n• ${members}`;
        });

        text += teams.join("\n\n");

        navigator.clipboard.writeText(text).then(() => {
            alert("Hasil disalin ke clipboard!");
        });
    }

    init();
    document.addEventListener("astro:after-swap", init);
</script>
