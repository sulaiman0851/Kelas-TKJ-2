---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { supabase } from '../../lib/supabase';

export const prerender = false;

// 1. Fetch Static Posts (Server Side)
const staticPosts = await getCollection('blog');
const formattedStatic = staticPosts.map(post => ({
    id: post.slug,
    title: post.data.title,
    description: post.data.description,
    slug: post.slug,
    created_at: post.data.pubDate.toISOString(),
    tags: post.data.tags,
    cover_image: null, // Static files might not have cover images in frontmatter yet
    is_static: true
}));

// 2. Fetch Dynamic Posts (Server Side for SEO/First Load)
const { data: dbPosts } = await supabase
    .from('blog_posts')
    .select('*')
    .eq('is_published', true)
    .order('created_at', { ascending: false });

const formattedDb = (dbPosts || []).map(post => ({
    ...post,
    is_static: false
}));

// 3. Merge and Sort
const allPosts = [...formattedStatic, ...formattedDb].sort((a, b) => 
    new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
);
---

<Layout title="Blog Room - Kelas TKJ" showSidebar={true} isBlog={true}>
    <div class="max-w-7xl mx-auto px-6 py-12">
        <header class="flex flex-col md:flex-row justify-between items-end gap-6 mb-16">
            <div class="max-w-2xl">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-black uppercase tracking-widest mb-4">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                    Latest Updates
                </div>
                <h1 class="text-6xl font-black text-white tracking-tighter mb-6">Blog Room</h1>
                <p class="text-lg text-slate-400 leading-relaxed">Panduan, tutorial, dan insight seputar Game Zone, pembelajaran interaktif, dan teknologi edukasi terbaru dari Kelas TKJ.</p>
            </div>
            <div class="flex gap-3" id="admin-actions">
                <!-- Check admin client-side -->
            </div>
        </header>

        <!-- Combined Grid -->
        <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {allPosts.map(post => (
                <article class="group relative bg-slate-900/50 border border-white/5 rounded-3xl overflow-hidden hover:border-blue-500/30 transition-all duration-500 flex flex-col h-full">
                    <a href={`/blog/${post.slug}`} class="block overflow-hidden relative aspect-video">
                        <img 
                            src={post.cover_image || 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&q=80&w=800'} 
                            alt={post.title} 
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                        />
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-950/80 via-transparent to-transparent"></div>
                        <div class="absolute top-4 left-4">
                            {post.is_static && (
                                <span class="px-2 py-1 rounded-lg bg-orange-500/20 backdrop-blur-md border border-orange-500/30 text-[8px] font-black text-orange-400 uppercase tracking-widest">
                                    Static
                                </span>
                            )}
                        </div>
                        <div class="absolute bottom-4 left-6">
                             <div class="flex gap-2">
                                {(post.tags || []).slice(0, 2).map((tag: string) => (
                                    <span class="px-2 py-0.5 rounded-lg bg-blue-500/20 backdrop-blur-md border border-white/10 text-[9px] font-black text-blue-300 uppercase tracking-tighter">
                                        {tag}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </a>
                    <div class="p-8 flex-1 flex flex-col">
                        <div class="mb-4 text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            {new Date(post.created_at).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}
                        </div>
                        <h2 class="text-2xl font-black text-white mb-4 group-hover:text-blue-400 transition-colors tracking-tight line-clamp-2">
                            <a href={`/blog/${post.slug}`}>{post.title}</a>
                        </h2>
                        <p class="text-slate-400 text-sm leading-relaxed mb-8 line-clamp-3">
                            {post.description}
                        </p>
                        <div class="mt-auto pt-6 border-t border-white/5 flex justify-between items-center text-xs">
                            <span class="text-slate-500 font-bold group-hover:text-white transition-colors">Read Article</span>
                            <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400 group-hover:bg-blue-600 group-hover:text-white transition-all duration-500 group-hover:translate-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                            </div>
                        </div>
                    </div>
                </article>
            ))}
        </div>

        {allPosts.length === 0 && (
            <div id="empty-state" class="py-24 text-center">
                <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Belum ada postingan</h3>
                <p class="text-slate-500">Stay tuned untuk update menarik berikutnya!</p>
            </div>
        )}
    </div>
</Layout>

<script>
    import { supabase } from '../../lib/supabase';

    async function checkAdmin() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            const { data: roles } = await supabase.from('user_roles').select('roles(name)').eq('user_id', session.user.id);
            const isAdmin = roles?.some((r: any) => r.roles.name === 'admin');
            if (isAdmin) {
                const adminActions = document.getElementById('admin-actions');
                if (adminActions) {
                    adminActions.innerHTML = `
                        <a href="/admin/manage-blog" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black shadow-xl shadow-blue-600/20 transition-all flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            Manage Blog
                        </a>
                    `;
                }
            }
        }
    }

    checkAdmin();
    document.addEventListener('astro:after-swap', checkAdmin);
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
