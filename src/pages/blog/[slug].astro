---
import Layout from '../../layouts/Layout.astro';
import { getEntry } from 'astro:content';
import { supabase } from '../../lib/supabase';

export const prerender = false;

const { slug } = Astro.params;

let post: any = null;
let isStatic = false;
let Content: any = null;

// 1. Try fetching from Static Content Collection
const staticEntry = await getEntry('blog', slug!);
if (staticEntry) {
    post = {
        title: staticEntry.data.title,
        description: staticEntry.data.description,
        created_at: staticEntry.data.pubDate.toISOString(),
        tags: staticEntry.data.tags,
        cover_image: null, // Default or specific image for static
    };
    const rendered = await staticEntry.render();
    Content = rendered.Content;
    isStatic = true;
} else {
    // 2. Try fetching from Supabase
    const { data: dbPost } = await supabase
        .from('blog_posts')
        .select('*')
        .eq('slug', slug)
        .single();
    
    if (dbPost) {
        post = dbPost;
        isStatic = false;
    }
}
---

<Layout title={`${post?.title || 'Not Found'} - Kelas TKJ`}>
    {post ? (
        <div class="min-h-screen">
            <div class="relative h-[60vh] overflow-hidden">
                <img 
                    src={post.cover_image || 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&q=80&w=1600'} 
                    class="w-full h-full object-cover"
                    alt={post.title}
                />
                <div class="absolute inset-0 bg-gradient-to-b from-slate-950/20 via-slate-950/60 to-slate-950"></div>
                <div class="absolute top-8 left-8 z-20">
                    <a href="/blog" class="flex items-center gap-2 text-white/50 hover:text-white transition-all group font-black uppercase text-[10px] tracking-widest bg-black/20 backdrop-blur-md px-6 py-4 rounded-2xl border border-white/5 hover:border-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg>
                        Kembali ke Blog
                    </a>
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-6 -mt-40 relative z-10 pb-24">
                <article class="bg-slate-900/60 backdrop-blur-2xl border border-white/5 rounded-[3rem] p-8 md:p-16 shadow-2xl">
                    <div class="flex flex-wrap gap-3 mb-8">
                        {isStatic && (
                            <span class="px-3 py-1 rounded-full bg-orange-500/10 border border-orange-500/20 text-xs font-black text-orange-400 uppercase tracking-widest">
                                # Static Archive
                            </span>
                        )}
                        {(post.tags || []).map((tag: string) => (
                            <span class="px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-xs font-black text-blue-400 uppercase tracking-widest">
                                # {tag}
                            </span>
                        ))}
                    </div>

                    <div class="mb-12">
                        <div class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-4 flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            Dipublikasikan pada {new Date(post.created_at).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}
                        </div>
                        <h1 class="text-4xl md:text-6xl font-black text-white leading-[1.1] tracking-tighter mb-8 bg-clip-text text-transparent bg-gradient-to-br from-white via-white to-slate-500">
                            {post.title}
                        </h1>
                        <p class="text-xl text-slate-400 leading-relaxed font-medium italic border-l-4 border-blue-600 pl-6">
                            "{post.description}"
                        </p>
                    </div>

                    <div class="prose prose-invert prose-lg max-w-none 
                        prose-headings:font-black prose-headings:tracking-tighter prose-headings:text-white
                        prose-p:text-slate-400 prose-p:leading-loose
                        prose-strong:text-white prose-strong:font-black
                        prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline
                        prose-img:rounded-3xl prose-img:border prose-img:border-white/5
                        prose-ul:text-slate-400 prose-li:marker:text-blue-500
                    ">
                        {isStatic ? <Content /> : <div set:html={post.content} />}
                    </div>

                    <div class="mt-20 pt-12 border-t border-white/5 flex flex-col md:flex-row justify-between items-center gap-8">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center font-black text-white shadow-lg shadow-blue-600/20">
                                TKJ
                            </div>
                            <div>
                                <div class="text-xs font-black text-slate-500 uppercase tracking-widest">Penulis</div>
                                <div class="text-white font-bold">{isStatic ? 'Admin Archive' : 'Admin Kelas TKJ'}</div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    ) : (
        <div class="flex flex-col items-center justify-center min-h-[70vh] text-center px-6">
            <h1 class="text-6xl font-black text-white mb-4 tracking-tighter">404</h1>
            <p class="text-slate-500 mb-8 max-w-xs">Postingan yang Anda cari tidak tersedia atau telah dihapus.</p>
            <a href="/blog" class="px-8 py-4 bg-white text-black font-black rounded-2xl hover:bg-slate-200 transition-all uppercase text-[10px] tracking-widest">Back to Blog</a>
        </div>
    )}
</Layout>

<style is:global>
    /* Custom Scrollbar for Blog */
    ::-webkit-scrollbar {
        width: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #020617;
    }
    ::-webkit-scrollbar-thumb {
        background: #1e293b;
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #334155;
    }

    /* Content styling */
    .prose img {
        width: 100%;
        margin: 2.5rem 0;
    }
    .prose h1, .prose h2, .prose h3 {
        margin-top: 4rem;
        margin-bottom: 2rem;
        font-weight: 900;
        letter-spacing: -0.05em;
        color: white;
    }
    .prose h1 { font-size: 3rem; }
    .prose h2 { font-size: 2.25rem; }
    .prose p { margin-bottom: 1.5rem; }
</style>
