---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Jadwal Pelajaran - Kelas TKJ">
    <header class="flex justify-between items-center mb-10">
        <div>
            <h2 class="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-500 tracking-tight">Jadwal Pelajaran</h2>
            <p class="text-slate-400 mt-1">Kelola dan pantau agenda belajar harianmu</p>
        </div>
        <div id="admin-actions" class="hidden">
             <!-- Admin only buttons -->
        </div>
    </header>

    <!-- Day Navigation -->
    <div class="flex gap-3 mb-10 overflow-x-auto pb-4 no-scrollbar scroll-smooth">
        {['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'].map((day, index) => (
            <button 
                data-day={index}
                class="day-tab px-8 py-3.5 rounded-2xl font-black text-sm transition-all whitespace-nowrap cursor-pointer border border-white/5 bg-slate-900 text-slate-500 hover:text-white hover:bg-white/5 active:scale-95"
            >
                {day}
            </button>
        ))}
    </div>

    <!-- Schedule Content -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
        <!-- Main Timeline -->
        <div class="lg:col-span-8 space-y-6">
            <div id="schedule-container" class="relative pl-8 border-l border-white/5 space-y-8">
                <!-- Skeletons -->
                {[1,2,3].map(() => (
                    <div class="animate-pulse flex gap-6">
                        <div class="w-20 pt-2"><div class="h-3 bg-white/5 rounded w-full"></div></div>
                        <div class="flex-1 bg-white/3 rounded-3xl p-6 h-32 border border-white/5"></div>
                    </div>
                ))}
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-gradient-to-br from-orange-600/20 to-transparent border border-orange-500/10 p-8 rounded-[2rem] shadow-2xl relative overflow-hidden group h-fit">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-orange-500/10 rounded-full blur-[60px] group-hover:bg-orange-500/20 transition-all duration-700"></div>
                <h3 class="text-2xl font-black text-white mb-4 leading-tight">Sedang Berlangsung</h3>
                <div id="current-subject" class="space-y-4">
                    <p class="text-slate-500 text-sm font-medium italic">Memuat info...</p>
                </div>
            </div>

            <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 p-8 rounded-[2rem] shadow-xl">
                <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-blue-500"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                    Daftar Mata Pelajaran
                </h3>
                <div id="subject-list" class="space-y-4">
                    <!-- Loaded via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <dialog id="admin-modal" class="bg-slate-950 text-white border border-white/10 rounded-[2.5rem] p-10 backdrop:bg-slate-950/90 w-full max-w-lg shadow-2xl">
        <h3 class="text-3xl font-black mb-8 tracking-tight">Tambah Jadwal</h3>
        <form id="schedule-form" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div>
                     <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Hari</label>
                     <select id="form-day" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none transition-all appearance-none cursor-pointer">
                        <option value="0">Senin</option>
                        <option value="1">Selasa</option>
                        <option value="2">Rabu</option>
                        <option value="3">Kamis</option>
                        <option value="4">Jumat</option>
                        <option value="5">Sabtu</option>
                     </select>
                </div>
                <div>
                     <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Ruangan</label>
                     <input type="text" id="form-room" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none" placeholder="Contoh: Lab 1">
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Mata Pelajaran</label>
                <select id="form-subject" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none transition-all appearance-none cursor-pointer">
                    <!-- Dynamic -->
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Jam Mulai</label>
                    <input type="time" id="form-start" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Jam Selesai</label>
                    <input type="time" id="form-end" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none">
                </div>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="button" onclick="document.getElementById('admin-modal').close()" class="flex-1 px-8 py-4 rounded-2xl bg-white/5 hover:bg-white/10 font-bold transition-all cursor-pointer">Batal</button>
                <button type="submit" class="flex-1 px-8 py-4 bg-orange-600 hover:bg-orange-500 shadow-xl shadow-orange-600/20 rounded-2xl font-black transition-all cursor-pointer">Simpan Jadwal</button>
            </div>
        </form>
    </dialog>
</Layout>

<script>
    import { supabase } from '../lib/supabase';

    let currentDay = new Date().getDay() - 1; // 0 = Mon
    if (currentDay < 0 || currentDay > 5) currentDay = 0; // Default to Monday if Sunday

    let allSubjects: any[] = [];
    let isAdmin = false;

    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            const { data: roleData } = await supabase.from('user_roles').select('roles(name)').eq('user_id', session.user.id);
            isAdmin = roleData?.some((r: any) => r.roles.name === 'admin') || false;
            if (isAdmin) renderAdminActions();
        }

        await loadSubjects();
        // Since we now show a weekly grid, we don't need day tabs for filtering
        const dayNav = document.querySelector('.flex.gap-3.mb-10');
        if (dayNav) dayNav.remove(); 
        
        await renderSchedule();
        updateTimelineStatus();
        setInterval(updateTimelineStatus, 60000); // Update every minute
    }

    function renderAdminActions() {
        const container = document.getElementById('admin-actions');
        if (container) {
            container.innerHTML = `
                <button onclick="document.getElementById('admin-modal').showModal()" class="px-6 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-2xl font-black shadow-xl shadow-orange-600/20 transition-all flex items-center gap-2 cursor-pointer active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Tambah Jadwal
                </button>
            `;
        }
    }

    async function loadSubjects() {
        const { data } = await supabase.from('subjects').select('*').order('name');
        allSubjects = data || [];
        
        const subList = document.getElementById('subject-list');
        const subSelect = document.getElementById('form-subject');
        
        if (subList) {
            subList.innerHTML = allSubjects.map(s => `
                <div class="flex items-center gap-4 p-4 rounded-2xl bg-white/3 border border-white/5 hover:bg-white/5 transition-colors">
                    <div class="w-10 h-10 rounded-xl bg-${s.color}-500/10 flex items-center justify-center text-${s.color}-400">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/></svg>
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-black text-white truncate uppercase">${s.code || s.name}</p>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">${s.teacher_name || 'Tanpa Pengajar'}</p>
                    </div>
                </div>
            `).join('');
        }

        if (subSelect) {
            subSelect.innerHTML = allSubjects.map(s => `<option value="${s.id}">${s.code || s.name} - ${s.name}</option>`).join('');
        }
    }

    // dayTabs logic removed in favour of full grid view

    async function renderSchedule() {
        const container = document.getElementById('schedule-container');
        if (!container) return;

        const { data: scheduleData } = await supabase
            .from('schedule')
            .select('*, subject:subjects(*)');

        const days = ['SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT'];
        const slots = [
            { label: '1 - 2', start: '07:00', end: '08:30' },
            { label: '3 - 4', start: '08:45', end: '10:15' },
            { label: '5 - 6', start: '10:30', end: '12:00' },
            { label: '7 - 8', start: '13:00', end: '14:30' }
        ];

        // Create Grid Structure
        let html = `
            <div class="overflow-x-auto pb-6">
                <table class="w-full border-collapse rounded-3xl overflow-hidden bg-slate-900/50 backdrop-blur-xl border border-white/5 shadow-2xl min-w-[800px]">
                    <thead>
                        <tr class="bg-white/5">
                            <th class="p-6 border-b border-r border-white/5 w-32"></th>
                            ${slots.map(s => `
                                <th class="p-6 border-b border-r border-white/10 text-center">
                                    <div class="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] mb-1">Jam Ke</div>
                                    <div class="text-xl font-black text-white">${s.label}</div>
                                    <div class="text-[8px] font-bold text-slate-600 font-mono mt-1">${s.start} - ${s.end}</div>
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
        `;

        const now = new Date();
        const currentD = now.getDay() - 1; 
        const currentTime = now.getHours() * 3600 + now.getMinutes() * 60;

        days.forEach((day, dIdx) => {
            html += `
                <tr class="hover:bg-white/5 group border-b border-white/5">
                    <td class="p-6 border-r border-white/10 bg-white/2">
                        <div class="text-sm font-black text-slate-400 group-hover:text-orange-400 transition-colors tracking-widest">${day}</div>
                    </td>
            `;

            slots.forEach(slot => {
                const item = scheduleData?.find(s => s.day_of_week === dIdx && s.start_time.startsWith(slot.start));
                const subject = item?.subject;
                
                // Active status check
                const [sh, sm] = slot.start.split(':').map(Number);
                const [eh, em] = slot.end.split(':').map(Number);
                const isActive = dIdx === currentD && currentTime >= (sh*60+sm) && currentTime <= (eh*60+em);

                html += `
                    <td class="p-6 border-r border-white/5 text-center relative ${isActive ? 'bg-orange-600/10' : ''} transition-all">
                        ${isActive ? '<div class="absolute left-0 top-0 w-full h-1 bg-orange-600 shadow-[0_0_10px_rgba(234,88,12,0.5)] animate-pulse"></div>' : ''}
                        
                        ${subject ? `
                            <div class="space-y-1">
                                <div class="text-2xl font-black text-white group-hover:text-blue-400 leading-none transition-colors">${subject.code || subject.name}</div>
                                <div class="text-[8px] font-bold text-slate-600 uppercase tracking-tighter leading-tight italic break-words max-w-[120px] mx-auto">${subject.teacher_name || ''}</div>
                                ${isAdmin ? `
                                    <button onclick="deleteSchedule(${item.id})" class="mt-2 text-[8px] font-black text-red-500/30 hover:text-red-500 uppercase tracking-widest cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">Hapus</button>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="text-slate-800 font-black text-sm italic">-</div>
                        `}
                    </td>
                `;
            });

            html += `</tr>`;
        });

        html += `
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex items-center justify-center gap-6">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-orange-600 shadow-[0_0_5px_rgba(234,88,12,1)]"></div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Sedang Berlangsung</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-slate-800"></div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Jadwal Lain</span>
                </div>
            </div>
        `;

        container.classList.remove('pl-8', 'border-l');
        container.innerHTML = html;
    }

    async function updateTimelineStatus() {
        const now = new Date();
        const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const currentD = now.getDay() - 1; 

        if (currentD < 0 || currentD > 5) {
            document.getElementById('current-subject')!.innerHTML = '<p class="text-slate-500 text-sm font-bold animate-pulse">Weekend! Selamat beristirahat. âœ¨</p>';
            return;
        }

        const { data: schedule } = await supabase
            .from('schedule')
            .select('*, subject:subjects(*)')
            .eq('day_of_week', currentD);
        
        const active = schedule?.find(item => {
            const [sh, sm] = item.start_time.split(':').map(Number);
            const [eh, em] = item.end_time.split(':').map(Number);
            const start = sh * 3600 + sm * 60;
            const end = eh * 3600 + em * 60;
            return currentTime >= start && currentTime <= end;
        });

        const container = document.getElementById('current-subject');
        if (!container) return;

        if (active) {
            container.innerHTML = `
                <div class="space-y-4">
                    <p class="text-[10px] font-black uppercase text-orange-400 tracking-[0.3em]">Mata Pelajaran</p>
                    <h4 class="text-3xl font-black text-white leading-none uppercase">${active.subject.name}</h4>
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 bg-white/5 rounded-xl text-xs font-mono font-black text-white border border-white/5">
                            ${active.start_time.substring(0,5)} - ${active.end_time.substring(0,5)}
                        </span>
                        <span class="px-4 py-2 bg-orange-600 rounded-xl text-xs font-black text-white shadow-lg shadow-orange-600/20">
                            ${active.room || 'R. Kelas'}
                        </span>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<p class="text-slate-500 text-sm font-bold opacity-60">Tidak ada pelajaran aktif saat ini.</p>';
        }
    }

    // Form Handling
    document.getElementById('schedule-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = {
            day_of_week: parseInt((document.getElementById('form-day') as HTMLSelectElement).value),
            subject_id: parseInt((document.getElementById('form-subject') as HTMLSelectElement).value),
            room: (document.getElementById('form-room') as HTMLInputElement).value,
            start_time: (document.getElementById('form-start') as HTMLInputElement).value,
            end_time: (document.getElementById('form-end') as HTMLInputElement).value
        };

        const { error } = await supabase.from('schedule').insert(formData);
        if (error) alert(error.message);
        else {
            (document.getElementById('admin-modal') as HTMLDialogElement).close();
            await renderSchedule();
            updateTimelineStatus();
        }
    });

    (window as any).deleteSchedule = async (id: number) => {
        if (!confirm('Hapus jadwal ini?')) return;
        const { error } = await supabase.from('schedule').delete().eq('id', id);
        if (error) alert(error.message);
        else {
            await renderSchedule();
            updateTimelineStatus();
        }
    };

    init();
    document.addEventListener('astro:after-swap', init);
</script>

<style is:global>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
