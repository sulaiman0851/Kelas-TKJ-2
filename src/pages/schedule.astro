---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Jadwal Pelajaran - Kelas TKJ">
    <header class="flex justify-between items-center mb-10">
        <div>
            <h2 class="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-500 tracking-tight">Jadwal Pelajaran</h2>
            <p class="text-slate-400 mt-1">Kelola dan pantau agenda belajar harianmu</p>
        </div>
        <div id="admin-actions" class="hidden">
             <!-- Admin only buttons -->
        </div>
    </header>

    <!-- Day Navigation -->
    <div class="flex gap-3 mb-10 overflow-x-auto pb-4 no-scrollbar scroll-smooth">
        {['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'].map((day, index) => (
            <button 
                data-day={index}
                class="day-tab px-8 py-3.5 rounded-2xl font-black text-sm transition-all whitespace-nowrap cursor-pointer border border-white/5 bg-slate-900 text-slate-500 hover:text-white hover:bg-white/5 active:scale-95"
            >
                {day}
            </button>
        ))}
    </div>

    <!-- Schedule Content -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
        <!-- Main Timeline -->
        <div class="lg:col-span-8 space-y-6">
            <div id="schedule-container" class="relative pl-8 border-l border-white/5 space-y-8">
                <!-- Skeletons -->
                {[1,2,3].map(() => (
                    <div class="animate-pulse flex gap-6">
                        <div class="w-20 pt-2"><div class="h-3 bg-white/5 rounded w-full"></div></div>
                        <div class="flex-1 bg-white/3 rounded-3xl p-6 h-32 border border-white/5"></div>
                    </div>
                ))}
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-gradient-to-br from-orange-600/20 to-transparent border border-orange-500/10 p-8 rounded-[2rem] shadow-2xl relative overflow-hidden group h-fit">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-orange-500/10 rounded-full blur-[60px] group-hover:bg-orange-500/20 transition-all duration-700"></div>
                <h3 class="text-2xl font-black text-white mb-4 leading-tight">Sedang Berlangsung</h3>
                <div id="current-subject" class="space-y-4">
                    <p class="text-slate-500 text-sm font-medium italic">Memuat info...</p>
                </div>
            </div>

            <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 p-8 rounded-[2rem] shadow-xl">
                <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-blue-500"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                    Daftar Mata Pelajaran
                </h3>
                <div id="subject-list" class="space-y-4">
                    <!-- Loaded via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <dialog id="admin-modal" class="bg-slate-950 text-white border border-white/10 rounded-[2.5rem] p-10 backdrop:bg-slate-950/90 w-full max-w-lg shadow-2xl">
        <h3 class="text-3xl font-black mb-8 tracking-tight">Tambah Jadwal</h3>
        <form id="schedule-form" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div>
                     <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Hari</label>
                     <select id="form-day" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none transition-all appearance-none cursor-pointer">
                        <option value="0">Senin</option>
                        <option value="1">Selasa</option>
                        <option value="2">Rabu</option>
                        <option value="3">Kamis</option>
                        <option value="4">Jumat</option>
                        <option value="5">Sabtu</option>
                     </select>
                </div>
                <div>
                     <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Ruangan</label>
                     <input type="text" id="form-room" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none" placeholder="Contoh: Lab 1">
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Mata Pelajaran</label>
                <select id="form-subject" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none transition-all appearance-none cursor-pointer">
                    <!-- Dynamic -->
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Jam Mulai</label>
                    <input type="time" id="form-start" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Jam Selesai</label>
                    <input type="time" id="form-end" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none">
                </div>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="button" onclick="document.getElementById('admin-modal').close()" class="flex-1 px-8 py-4 rounded-2xl bg-white/5 hover:bg-white/10 font-bold transition-all cursor-pointer">Batal</button>
                <button type="submit" class="flex-1 px-8 py-4 bg-orange-600 hover:bg-orange-500 shadow-xl shadow-orange-600/20 rounded-2xl font-black transition-all cursor-pointer">Simpan Jadwal</button>
            </div>
        </form>
    </dialog>
</Layout>

<script>
    import { supabase } from '../lib/supabase';

    let currentDay = new Date().getDay() - 1; // 0 = Mon
    if (currentDay < 0 || currentDay > 5) currentDay = 0; // Default to Monday if Sunday

    let allSubjects: any[] = [];
    let isAdmin = false;

    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            const { data: roleData } = await supabase.from('user_roles').select('roles(name)').eq('user_id', session.user.id);
            isAdmin = roleData?.some((r: any) => r.roles.name === 'admin') || false;
            if (isAdmin) renderAdminActions();
        }

        await loadSubjects();
        setupDayTabs();
        await renderSchedule(currentDay);
        updateTimelineStatus();
        setInterval(updateTimelineStatus, 60000); // Update every minute
    }

    function renderAdminActions() {
        const container = document.getElementById('admin-actions');
        if (container) {
            container.innerHTML = `
                <button onclick="document.getElementById('admin-modal').showModal()" class="px-6 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-2xl font-black shadow-xl shadow-orange-600/20 transition-all flex items-center gap-2 cursor-pointer active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Tambah Jadwal
                </button>
            `;
        }
    }

    async function loadSubjects() {
        const { data } = await supabase.from('subjects').select('*').order('name');
        allSubjects = data || [];
        
        const subList = document.getElementById('subject-list');
        const subSelect = document.getElementById('form-subject');
        
        if (subList) {
            subList.innerHTML = allSubjects.map(s => `
                <div class="flex items-center gap-4 p-4 rounded-2xl bg-white/3 border border-white/5 hover:bg-white/5 transition-colors">
                    <div class="w-10 h-10 rounded-xl bg-${s.color}-500/10 flex items-center justify-center text-${s.color}-400">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/></svg>
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-black text-white truncate uppercase">${s.name}</p>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">${s.teacher_name || 'Tanpa Pengajar'}</p>
                    </div>
                </div>
            `).join('');
        }

        if (subSelect) {
            subSelect.innerHTML = allSubjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }
    }

    function setupDayTabs() {
        const tabs = document.querySelectorAll('.day-tab');
        tabs.forEach(tab => {
            if (parseInt(tab.getAttribute('data-day')!) === currentDay) {
                tab.classList.remove('bg-slate-900', 'text-slate-500');
                tab.classList.add('bg-orange-600', 'text-white', 'shadow-lg', 'shadow-orange-600/20', 'border-orange-500/20');
            }

            tab.addEventListener('click', async () => {
                tabs.forEach(t => {
                    t.classList.remove('bg-orange-600', 'text-white', 'shadow-lg', 'shadow-orange-600/20', 'border-orange-500/20');
                    t.classList.add('bg-slate-900', 'text-slate-500');
                });
                tab.classList.remove('bg-slate-900', 'text-slate-500');
                tab.classList.add('bg-orange-600', 'text-white', 'shadow-lg', 'shadow-orange-600/20', 'border-orange-500/20');
                
                currentDay = parseInt(tab.getAttribute('data-day')!);
                await renderSchedule(currentDay);
            });
        });
    }

    async function renderSchedule(day: number) {
        const container = document.getElementById('schedule-container');
        if (!container) return;

        const { data: schedule } = await supabase
            .from('schedule')
            .select('*, subject:subjects(*)')
            .eq('day_of_week', day)
            .order('start_time');

        if (!schedule || schedule.length === 0) {
            container.innerHTML = `
                <div class="p-20 text-center space-y-4">
                    <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto text-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    </div>
                    <p class="text-slate-600 font-black uppercase text-xs tracking-widest italic">Tidak ada jadwal untuk hari ini</p>
                </div>
            `;
            return;
        }

        container.innerHTML = schedule.map((item, index) => {
            const startStr = item.start_time.substring(0, 5);
            const endStr = item.end_time.substring(0, 5);
            const subject = item.subject;

            return `
                <div class="relative group">
                    <!-- Timeline Dot -->
                    <div class="absolute -left-[37px] top-6 w-4 h-4 rounded-full border-4 border-slate-950 bg-orange-600 z-10 group-hover:scale-125 transition-transform duration-300"></div>
                    
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-32 pt-5">
                            <span class="text-xs font-black text-slate-500 group-hover:text-orange-400 transition-colors uppercase tracking-widest">${startStr} - ${endStr}</span>
                        </div>
                        
                        <div class="flex-1 bg-slate-900 border border-white/5 p-6 rounded-[2rem] hover:bg-white/5 hover:-translate-y-1 transition-all duration-300 shadow-xl group/card relative overflow-hidden">
                            <div class="absolute right-0 top-0 h-full w-1.5 bg-${subject.color || 'blue'}-500/50"></div>
                            <div class="flex justify-between items-start">
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3">
                                        <span class="px-3 py-1 bg-${subject.color || 'blue'}-500/10 text-${subject.color || 'blue'}-400 rounded-lg text-[9px] font-black uppercase tracking-widest border border-${subject.color || 'blue'}-500/20">${item.room || 'R. KELAS'}</span>
                                    </div>
                                    <h4 class="text-xl font-black text-white group-hover/card:text-${subject.color || 'blue'}-400 transition-colors uppercase leading-tight">${subject.name}</h4>
                                    <div class="flex items-center gap-2 text-slate-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="opacity-50"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        <span class="text-xs font-bold uppercase tracking-tighter">${subject.teacher_name || 'Guru Pengampu'}</span>
                                    </div>
                                </div>
                                ${isAdmin ? `
                                    <button onclick="deleteSchedule(${item.id})" class="p-3 hover:bg-red-500/10 text-slate-600 hover:text-red-500 rounded-2xl transition-all cursor-pointer">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function updateTimelineStatus() {
        const now = new Date();
        const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const currentD = now.getDay() - 1; 

        if (currentD < 0 || currentD > 5) {
            document.getElementById('current-subject')!.innerHTML = '<p class="text-slate-500 text-sm font-bold animate-pulse">Weekend! Selamat beristirahat. âœ¨</p>';
            return;
        }

        const { data: schedule } = await supabase
            .from('schedule')
            .select('*, subject:subjects(*)')
            .eq('day_of_week', currentD);
        
        const active = schedule?.find(item => {
            const [sh, sm] = item.start_time.split(':').map(Number);
            const [eh, em] = item.end_time.split(':').map(Number);
            const start = sh * 3600 + sm * 60;
            const end = eh * 3600 + em * 60;
            return currentTime >= start && currentTime <= end;
        });

        const container = document.getElementById('current-subject');
        if (!container) return;

        if (active) {
            container.innerHTML = `
                <div class="space-y-4">
                    <p class="text-[10px] font-black uppercase text-orange-400 tracking-[0.3em]">Mata Pelajaran</p>
                    <h4 class="text-3xl font-black text-white leading-none uppercase">${active.subject.name}</h4>
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 bg-white/5 rounded-xl text-xs font-mono font-black text-white border border-white/5">
                            ${active.start_time.substring(0,5)} - ${active.end_time.substring(0,5)}
                        </span>
                        <span class="px-4 py-2 bg-orange-600 rounded-xl text-xs font-black text-white shadow-lg shadow-orange-600/20">
                            ${active.room || 'R. Kelas'}
                        </span>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<p class="text-slate-500 text-sm font-bold opacity-60">Tidak ada pelajaran aktif saat ini.</p>';
        }
    }

    // Form Handling
    document.getElementById('schedule-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = {
            day_of_week: parseInt((document.getElementById('form-day') as HTMLSelectElement).value),
            subject_id: parseInt((document.getElementById('form-subject') as HTMLSelectElement).value),
            room: (document.getElementById('form-room') as HTMLInputElement).value,
            start_time: (document.getElementById('form-start') as HTMLInputElement).value,
            end_time: (document.getElementById('form-end') as HTMLInputElement).value
        };

        const { error } = await supabase.from('schedule').insert(formData);
        if (error) alert(error.message);
        else {
            (document.getElementById('admin-modal') as HTMLDialogElement).close();
            await renderSchedule(currentDay);
            updateTimelineStatus();
        }
    });

    (window as any).deleteSchedule = async (id: number) => {
        if (!confirm('Hapus jadwal ini?')) return;
        const { error } = await supabase.from('schedule').delete().eq('id', id);
        if (error) alert(error.message);
        else {
            await renderSchedule(currentDay);
            updateTimelineStatus();
        }
    };

    init();
    document.addEventListener('astro:after-swap', init);
</script>

<style is:global>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
