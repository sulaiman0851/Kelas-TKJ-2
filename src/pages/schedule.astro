---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Jadwal Pelajaran - Kelas TKJ">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
        <div>
            <h2 class="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-500 tracking-tight">Jadwal Pelajaran</h2>
            <p class="text-slate-400 mt-1">Kelola dan pantau agenda belajar harianmu</p>
        </div>
        <div class="flex gap-3">
            <button id="export-word-btn" class="px-6 py-3 bg-white/5 hover:bg-white/10 text-white rounded-2xl font-black transition-all flex items-center gap-2 cursor-pointer active:scale-95 border border-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export Word
            </button>
            <div id="admin-actions" class="hidden">
                 <!-- Admin only buttons -->
            </div>
        </div>
    </header>

    <!-- Day Navigation -->
    <div class="flex gap-3 mb-10 overflow-x-auto pb-4 no-scrollbar scroll-smooth">
        {['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'].map((day, index) => (
            <button 
                data-day={index}
                class="day-tab px-8 py-3.5 rounded-2xl font-black text-sm transition-all whitespace-nowrap cursor-pointer border border-white/5 bg-slate-900 text-slate-500 hover:text-white hover:bg-white/5 active:scale-95"
            >
                {day}
            </button>
        ))}
    </div>

    <!-- Schedule Content -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
        <!-- Main Timeline -->
        <div class="lg:col-span-8 space-y-6">
            <div id="schedule-container" class="relative pl-8 border-l border-white/5 space-y-8">
                <!-- Skeletons -->
                {[1,2,3].map(() => (
                    <div class="animate-pulse flex gap-6">
                        <div class="w-20 pt-2"><div class="h-3 bg-white/5 rounded w-full"></div></div>
                        <div class="flex-1 bg-white/3 rounded-3xl p-6 h-32 border border-white/5"></div>
                    </div>
                ))}
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-gradient-to-br from-orange-600/20 to-transparent border border-orange-500/10 p-8 rounded-[2rem] shadow-2xl relative overflow-hidden group h-fit">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-orange-500/10 rounded-full blur-[60px] group-hover:bg-orange-500/20 transition-all duration-700"></div>
                <h3 class="text-2xl font-black text-white mb-4 leading-tight">Sedang Berlangsung</h3>
                <div id="current-subject" class="space-y-4">
                    <p class="text-slate-500 text-sm font-medium italic">Memuat info...</p>
                </div>
            </div>

            <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 p-8 rounded-[2rem] shadow-xl">
                <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-blue-500"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                    Daftar Mata Pelajaran
                </h3>
                <div id="subject-list" class="space-y-4">
                    <!-- Loaded via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <dialog id="admin-modal" class="bg-slate-950 text-white border border-white/10 rounded-[2.5rem] p-10 backdrop:bg-slate-950/90 w-full max-w-lg shadow-2xl">
        <h3 class="text-3xl font-black mb-8 tracking-tight">Tambah Jadwal</h3>
        <form id="schedule-form" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div>
                     <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Hari</label>
                     <select id="form-day" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none transition-all appearance-none cursor-pointer">
                        <option value="0">Senin</option>
                        <option value="1">Selasa</option>
                        <option value="2">Rabu</option>
                        <option value="3">Kamis</option>
                        <option value="4">Jumat</option>
                        <option value="5">Sabtu</option>
                     </select>
                </div>
                <div>
                     <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Ruangan</label>
                     <input type="text" id="form-room" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none" placeholder="Contoh: Lab 1">
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Mata Pelajaran</label>
                <select id="form-subject" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none transition-all appearance-none cursor-pointer">
                    <!-- Dynamic -->
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Jam Mulai</label>
                    <input type="time" id="form-start" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Jam Selesai</label>
                    <input type="time" id="form-end" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-orange-500/50 outline-none">
                </div>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="button" onclick="document.getElementById('admin-modal').close()" class="flex-1 px-8 py-4 rounded-2xl bg-white/5 hover:bg-white/10 font-bold transition-all cursor-pointer">Batal</button>
                <button type="submit" class="flex-1 px-8 py-4 bg-orange-600 hover:bg-orange-500 shadow-xl shadow-orange-600/20 rounded-2xl font-black transition-all cursor-pointer">Simpan Jadwal</button>
            </div>
        </form>
    </dialog>
</Layout>

<script>
    import { supabase } from '../lib/supabase';
    import { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, ShadingType, AlignmentType, TextRun } from "docx";
    // @ts-ignore
    import { saveAs } from "file-saver";

    let currentDay = new Date().getDay() - 1; // 0 = Mon
    if (currentDay < 0 || currentDay > 5) currentDay = 0; // Default to Monday if Sunday

    let allSubjects: any[] = [];
    let isAdmin = false;
    let scheduleData: any[] = [];

    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            const { data: roleData } = await supabase.from('user_roles').select('roles(name)').eq('user_id', session.user.id);
            isAdmin = roleData?.some((r: any) => r.roles.name === 'admin') || false;
            if (isAdmin) renderAdminActions();
        }

        await loadSubjects();
        // Since we now show a weekly grid, we don't need day tabs for filtering
        const dayNav = document.querySelector('.flex.gap-3.mb-10');
        if (dayNav) dayNav.remove(); 
        
        await renderSchedule();
        updateTimelineStatus();
        
        // Export Word Event
        document.getElementById('export-word-btn')?.addEventListener('click', exportToWord);

        setInterval(updateTimelineStatus, 60000); // Update every minute
    }

    async function exportToWord() {
        const btn = document.getElementById('export-word-btn') as HTMLElement;
        const originalContent = btn.innerHTML;
        btn.innerHTML = 'Generating...';
        btn.style.opacity = '0.5';

        const days = ['SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT'];
        const slots = [
            { label: '1 - 2', start: '07:00-08:30' },
            { label: '3 - 4', start: '08:45-10:15' },
            { label: '5 - 6', start: '10:30-12:00' },
            { label: '7 - 8', start: '13:00-14:30' }
        ];

        // Create Header Row
        const headerRow = new TableRow({
            children: [
                new TableCell({
                    children: [new Paragraph({ text: "HARI / JAM", alignment: AlignmentType.CENTER })],
                    shading: { fill: "1E293B", type: ShadingType.CLEAR, color: "auto" },
                    verticalAlign: AlignmentType.CENTER,
                }),
                ...slots.map(slot => new TableCell({
                    children: [
                        new Paragraph({ 
                            children: [
                                new TextRun({ text: `JAM KE- ${slot.label}`, bold: true, color: "FFFFFF" }),
                            ],
                            alignment: AlignmentType.CENTER 
                        }),
                        new Paragraph({ 
                            children: [
                                new TextRun({ text: slot.start, size: 16, color: "CCCCCC" }),
                            ],
                            alignment: AlignmentType.CENTER 
                        }),
                    ],
                    shading: { fill: "334155", type: ShadingType.CLEAR, color: "auto" },
                }))
            ]
        });

        // Create Data Rows
        const dataRows = days.map((dayName, dIdx) => {
            const isAlternate = dIdx % 2 === 0;
            const rowBaseColor = isAlternate ? "F8FAFC" : "FFFFFF";

            return new TableRow({
                children: [
                    new TableCell({
                        children: [
                            new Paragraph({ 
                                children: [new TextRun({ text: dayName, bold: true })], 
                                alignment: AlignmentType.CENTER 
                            })
                        ],
                        shading: { fill: "F1F5F9" },
                    }),
                    ...slots.map(slot => {
                        const [sh] = slot.start.split(':');
                        const item = scheduleData.find(s => s.day_of_week === dIdx && s.start_time.startsWith(sh));
                        const subject = item?.subject;

                        return new TableCell({
                            children: [
                                new Paragraph({
                                    children: [
                                        new TextRun({ 
                                            text: subject ? (subject.code || subject.name) : "-", 
                                            bold: true,
                                            size: 24,
                                            color: subject ? "000000" : "999999"
                                        }),
                                    ],
                                    alignment: AlignmentType.CENTER
                                }),
                                new Paragraph({
                                    children: [
                                        new TextRun({ 
                                            text: subject?.teacher_name || "", 
                                            size: 16,
                                            italics: true,
                                            color: "666666"
                                        }),
                                    ],
                                    alignment: AlignmentType.CENTER
                                })
                            ],
                            shading: { fill: rowBaseColor }
                        });
                    })
                ]
            });
        });

        const doc = new Document({
            sections: [{
                children: [
                    new Paragraph({
                        children: [
                            new TextRun({ text: "JADWAL PELAJARAN KELAS TKJ", bold: true, size: 36 }),
                        ],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 }
                    }),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [headerRow, ...dataRows],
                    }),
                    new Paragraph({
                        text: `Data diekspor pada: ${new Date().toLocaleString('id-ID')}`,
                        alignment: AlignmentType.RIGHT,
                        spacing: { before: 200 }
                    })
                ],
            }],
        });

        const blob = await Packer.toBlob(doc);
        saveAs(blob, "Jadwal_Pelajaran_TKJ.docx");

        btn.innerHTML = originalContent;
        btn.style.opacity = '1';
    }

    function renderAdminActions() {
        const container = document.getElementById('admin-actions');
        if (container) {
            container.innerHTML = `
                <button onclick="document.getElementById('admin-modal').showModal()" class="px-6 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-2xl font-black shadow-xl shadow-orange-600/20 transition-all flex items-center gap-2 cursor-pointer active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    Tambah Jadwal
                </button>
            `;
        }
    }

    async function loadSubjects() {
        const { data } = await supabase.from('subjects').select('*').order('name');
        allSubjects = data || [];
        
        const subList = document.getElementById('subject-list');
        const subSelect = document.getElementById('form-subject');
        
        if (subList) {
            subList.innerHTML = allSubjects.map(s => `
                <div class="flex items-center gap-4 p-4 rounded-2xl bg-white/3 border border-white/5 hover:bg-white/5 transition-colors">
                    <div class="w-10 h-10 rounded-xl bg-${s.color}-500/10 flex items-center justify-center text-${s.color}-400">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/></svg>
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-black text-white truncate uppercase">${s.code || s.name}</p>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">${s.teacher_name || 'Tanpa Pengajar'}</p>
                    </div>
                </div>
            `).join('');
        }

        if (subSelect) {
            subSelect.innerHTML = allSubjects.map(s => `<option value="${s.id}">${s.code || s.name} - ${s.name}</option>`).join('');
        }
    }

    // dayTabs logic removed in favour of full grid view

    async function switchRundownDay(day: number) {
        const container = document.getElementById('daily-timeline');
        if (!container) return;

        // Update Tabs
        document.querySelectorAll('.rundown-tab').forEach((t, i) => {
            if (i === day) {
                t.classList.add('bg-blue-600', 'text-white', 'border-blue-500');
                t.classList.remove('bg-slate-900', 'text-slate-500');
            } else {
                t.classList.remove('bg-blue-600', 'text-white', 'border-blue-500');
                t.classList.add('bg-slate-900', 'text-slate-500');
            }
        });

        const { data: daySchedule } = await supabase
            .from('schedule')
            .select('*, subject:subjects(*)')
            .eq('day_of_week', day)
            .order('start_time');

        if (!daySchedule || daySchedule.length === 0) {
            container.innerHTML = '<p class="text-slate-600 font-black uppercase text-xs tracking-widest italic p-10">Tidak ada jadwal untuk hari ini</p>';
            return;
        }

        container.innerHTML = daySchedule.map((item) => {
            const subject = item.subject;
            const startStr = item.start_time.substring(0, 5);
            const endStr = item.end_time.substring(0, 5);
            
            const now = new Date();
            const currentD = now.getDay() - 1;
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            
            const [sh, sm] = item.start_time.split(':').map(Number);
            const [eh, em] = item.end_time.split(':').map(Number);
            const startTime = sh * 3600 + sm * 60;
            const endTime = eh * 3600 + em * 60;
            
            const isActive = day === currentD && currentTime >= startTime && currentTime <= endTime;

            return `
                <div class="relative group">
                    <div class="rundown-indicator absolute -left-[37px] top-6 w-4 h-4 rounded-full border-4 border-slate-950 ${isActive ? 'bg-blue-500' : 'bg-slate-700'} z-10 transition-all duration-500"></div>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-32 pt-5">
                            <span class="text-xs font-black ${isActive ? 'text-blue-400' : 'text-slate-500'} uppercase tracking-widest">${startStr} - ${endStr}</span>
                        </div>
                        <div class="flex-1 bg-slate-900 border border-white/5 p-6 rounded-[2rem] hover:bg-white/5 transition-all shadow-xl group/card relative overflow-hidden ${isActive ? 'glowing-rundown-active' : ''}">
                            <div class="absolute right-0 top-0 h-full w-1.5 bg-${subject.color || 'blue'}-500/50"></div>
                            <div class="flex justify-between items-start">
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2">
                                        <h4 class="text-xl font-black text-white uppercase leading-tight">${subject.name}</h4>
                                        ${isActive ? '<span class="px-2 py-0.5 rounded-lg bg-blue-500 text-[8px] font-black text-white animate-pulse uppercase tracking-widest">Live Now</span>' : ''}
                                    </div>
                                    <div class="flex items-center gap-2 text-slate-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="opacity-50"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        <span class="text-xs font-black uppercase tracking-tighter">${subject.teacher_name || 'Guru Pengampu'}</span>
                                    </div>
                                </div>
                                ${isAdmin ? `
                                    <button onclick="deleteSchedule(${item.id})" class="p-3 hover:bg-red-500/10 text-slate-600 hover:text-red-500 rounded-2xl transition-all cursor-pointer">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    (window as any).switchRundownDay = switchRundownDay;

    async function renderSchedule() {
        const container = document.getElementById('schedule-container');
        if (!container) return;

        const { data } = await supabase
            .from('schedule')
            .select('*, subject:subjects(*)');
        
        scheduleData = data || [];

        const days = ['SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT'];
        const slots = [
            { label: '1 - 2', start: '07:00', end: '08:30' },
            { label: '3 - 4', start: '08:45', end: '10:15' },
            { label: '5 - 6', start: '10:30', end: '12:00' },
            { label: '7 - 8', start: '13:00', end: '14:30' }
        ];

        // Create Grid Structure (Weekly View)
        let htmlChunks = [];
        htmlChunks.push(`
            <div class="mb-14">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-8 bg-orange-600 rounded-full"></div>
                    <h3 class="text-2xl font-black text-white uppercase tracking-tight">Tabel Mata Pelajaran</h3>
                </div>
                <div class="overflow-x-auto pb-6">
                    <table class="w-full border-collapse rounded-3xl overflow-hidden bg-slate-900/50 backdrop-blur-xl border border-white/5 shadow-2xl min-w-[800px]">
                        <thead>
                            <tr class="bg-white/5">
                                <th class="p-6 border-b border-r border-white/5 w-32"></th>
                                ${slots.map(s => `
                                    <th class="p-6 border-b border-r border-white/10 text-center">
                                        <div class="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] mb-1">Jam Ke</div>
                                        <div class="text-xl font-black text-white">${s.label}</div>
                                        <div class="text-[8px] font-bold text-slate-600 font-mono mt-1">${s.start} - ${s.end}</div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
        `);

        const now = new Date();
        const currentD = now.getDay() - 1; 
        const currentTime = now.getHours() * 3600 + now.getMinutes() * 60;

        days.forEach((day, dIdx) => {
            htmlChunks.push(`
                <tr class="hover:bg-white/5 group border-b border-white/5">
                    <td class="p-6 border-r border-white/10 bg-white/2">
                        <div class="text-sm font-black text-slate-400 group-hover:text-orange-400 transition-colors tracking-widest">${day}</div>
                    </td>
            `);

            slots.forEach(slot => {
                const item = scheduleData?.find(s => s.day_of_week === dIdx && s.start_time.startsWith(slot.start));
                const subject = item?.subject;
                const [sh, sm] = slot.start.split(':').map(Number);
                const [eh, em] = slot.end.split(':').map(Number);
                const startTime = sh * 3600 + sm * 60;
                const endTime = eh * 3600 + em * 60;
                const isActive = dIdx === currentD && currentTime >= startTime && currentTime <= endTime;

                htmlChunks.push(`
                    <td class="p-6 border-r border-white/5 text-center relative ${isActive ? 'glowing-table-active' : ''} transition-all duration-500">
                        ${isActive ? '<div class="absolute left-0 top-0 w-full h-1 bg-orange-500 glow-pulse"></div>' : ''}
                        ${isActive ? '<div class="absolute right-2 top-2"><span class="flex h-2 w-2 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-orange-500"></span></span></div>' : ''}
                        ${subject ? `
                            <div class="space-y-1 relative z-10">
                                <div class="text-2xl font-black ${isActive ? 'text-white' : 'text-white group-hover:text-blue-400'} leading-none transition-colors">${subject.code || subject.name}</div>
                                <div class="text-[8px] font-bold ${isActive ? 'text-orange-200' : 'text-slate-600'} uppercase tracking-tighter leading-tight italic break-words max-w-[120px] mx-auto">${subject.teacher_name || ''}</div>
                            </div>
                        ` : '<div class="text-slate-800 font-black text-sm italic">-</div>'}
                    </td>
                `);
            });
            htmlChunks.push(`</tr>`);
        });

        htmlChunks.push(`
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Daily Rundown View -->
            <div class="space-y-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-8 bg-blue-600 rounded-full"></div>
                        <h3 class="text-2xl font-black text-white uppercase tracking-tight">Rundown Harian</h3>
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                        ${days.map((day, idx) => `
                            <button 
                                onclick="switchRundownDay(${idx})"
                                id="rundown-tab-${idx}"
                                class="rundown-tab px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border border-white/5 ${idx === (currentDay >= 0 && currentDay < 5 ? currentDay : 0) ? 'bg-blue-600 text-white border-blue-500' : 'bg-slate-900 text-slate-500 hover:bg-white/5'}"
                            >
                                ${day}
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div id="daily-timeline" class="relative pl-8 border-l border-white/5 space-y-6 min-h-[300px]">
                    <!-- Rendered via JS -->
                </div>
            </div>
        `);

        container.innerHTML = htmlChunks.join('');
        switchRundownDay(currentDay >= 0 && currentDay < 5 ? currentDay : 0);
    }


    async function updateTimelineStatus() {
        const now = new Date();
        const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const currentD = now.getDay() - 1; 

        if (currentD < 0 || currentD > 5) {
            document.getElementById('current-subject')!.innerHTML = '<p class="text-slate-500 text-sm font-bold animate-pulse">Weekend! Selamat beristirahat. âœ¨</p>';
            return;
        }

        const { data: schedule } = await supabase
            .from('schedule')
            .select('*, subject:subjects(*)')
            .eq('day_of_week', currentD);
        
        const active = schedule?.find(item => {
            const [sh, sm] = item.start_time.split(':').map(Number);
            const [eh, em] = item.end_time.split(':').map(Number);
            const start = sh * 3600 + sm * 60;
            const end = eh * 3600 + em * 60;
            return currentTime >= start && currentTime <= end;
        });

        const container = document.getElementById('current-subject');
        if (!container) return;

        if (active) {
            container.innerHTML = `
                <div class="space-y-4">
                    <p class="text-[10px] font-black uppercase text-orange-400 tracking-[0.3em]">Mata Pelajaran</p>
                    <h4 class="text-3xl font-black text-white leading-none uppercase">${active.subject.name}</h4>
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 bg-white/5 rounded-xl text-xs font-mono font-black text-white border border-white/5">
                            ${active.start_time.substring(0,5)} - ${active.end_time.substring(0,5)}
                        </span>
                        <span class="px-4 py-2 bg-orange-600 rounded-xl text-xs font-black text-white shadow-lg shadow-orange-600/20">
                            ${active.room || 'R. Kelas'}
                        </span>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<p class="text-slate-500 text-sm font-bold opacity-60">Tidak ada pelajaran aktif saat ini.</p>';
        }
    }

    // Form Handling
    document.getElementById('schedule-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = {
            day_of_week: parseInt((document.getElementById('form-day') as HTMLSelectElement).value),
            subject_id: parseInt((document.getElementById('form-subject') as HTMLSelectElement).value),
            room: (document.getElementById('form-room') as HTMLInputElement).value,
            start_time: (document.getElementById('form-start') as HTMLInputElement).value,
            end_time: (document.getElementById('form-end') as HTMLInputElement).value
        };

        const { error } = await supabase.from('schedule').insert(formData);
        if (error) alert(error.message);
        else {
            (document.getElementById('admin-modal') as HTMLDialogElement).close();
            await renderSchedule();
            updateTimelineStatus();
        }
    });

    (window as any).deleteSchedule = async (id: number) => {
        if (!confirm('Hapus jadwal ini?')) return;
        const { error } = await supabase.from('schedule').delete().eq('id', id);
        if (error) alert(error.message);
        else {
            await renderSchedule();
            updateTimelineStatus();
        }
    };

    init();
    document.addEventListener('astro:after-swap', init);
</script>

<style is:global>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Glowing Active Effects */
    .glowing-table-active {
        background: rgba(234, 88, 12, 0.15) !important;
        position: relative;
        overflow: hidden;
        border: 2px solid rgba(234, 88, 12, 0.5) !important;
        box-shadow: 0 0 30px rgba(234, 88, 12, 0.2), inset 0 0 20px rgba(234, 88, 12, 0.1);
        z-index: 10;
        transform: scale(1.02);
    }

    .glowing-table-active::after {
        content: '';
        absolute: inset-0;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent);
        animation: shine 2s infinite;
    }

    .glowing-rundown-active {
        border-color: rgba(37, 99, 235, 0.5) !important;
        background: rgba(37, 99, 235, 0.1) !important;
        box-shadow: 0 0 40px rgba(37, 99, 235, 0.15);
        transform: translateX(10px);
    }

    .glowing-rundown-active .rundown-indicator {
        background: #2563eb !important;
        box-shadow: 0 0 15px #2563eb, 0 0 30px #2563eb;
        transform: scale(1.5);
    }

    @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    @keyframes pulse-glow {
        0%, 100% { opacity: 0.5; box-shadow: 0 0 10px rgba(234, 88, 12, 0.5); }
        50% { opacity: 1; box-shadow: 0 0 25px rgba(234, 88, 12, 0.8); }
    }

    .glow-pulse {
        animation: pulse-glow 2s infinite;
    }
</style>
