---
import Layout from '../../layouts/Layout.astro';
export const prerender = false;
---

<Layout title="Student Directory - Admin">
    <div class="mb-8 flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-bold mb-2">Student Directory</h1>
            <p class="text-slate-400">Tautkan akun pendaftar dengan daftar nama asli siswa</p>
        </div>
        <div class="flex gap-4">
            <a href="/admin/users" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors">Kelola User</a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Student List -->
        <div class="lg:col-span-2">
            <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
                <div class="p-6 border-b border-white/5 bg-white/5 flex justify-between items-center">
                    <h2 class="font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Daftar Nama Kelas
                    </h2>
                    <div id="directory-stats" class="text-xs font-bold text-slate-500 uppercase tracking-widest">
                        Memuat status...
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800/50 text-slate-400 text-[10px] uppercase tracking-widest font-black">
                            <tr>
                                <th class="p-4">No</th>
                                <th class="p-4">Nama Lengkap</th>
                                <th class="p-4">Status</th>
                                <th class="p-4">Akun Tertaut</th>
                                <th class="p-4 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="directory-list" class="divide-y divide-white/5">
                            {[1,2,3,4,5].map(() => (
                                <tr class="animate-pulse">
                                    <td class="p-4"><div class="h-4 bg-white/5 rounded w-4"></div></td>
                                    <td class="p-4"><div class="h-4 bg-white/5 rounded w-48"></div></td>
                                    <td class="p-4"><div class="h-6 bg-white/5 rounded-full w-20"></div></td>
                                    <td class="p-4"><div class="h-4 bg-white/5 rounded w-32"></div></td>
                                    <td class="p-4 text-right"><div class="h-4 bg-white/5 rounded w-12 ml-auto"></div></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Link Sidebar -->
        <div class="space-y-6">
            <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Daftar Akun Baru
                </h3>
                <p class="text-xs text-slate-500 mb-6">User yang belum ditautkan ke nama asli.</p>
                
                <div id="unlinked-users" class="space-y-3">
                    <div class="text-center py-8 text-slate-600 italic text-sm">Memuat user...</div>
                </div>
            </div>

            <div class="bg-blue-600/10 border border-blue-500/20 p-6 rounded-2xl">
                <h4 class="text-sm font-bold text-blue-400 mb-2">Informasi</h4>
                <p class="text-xs text-slate-400 leading-relaxed font-medium">Setelah ditautkan, sistem akan otomatis mengubah **Nama Lengkap** di profil user sesuai dengan database master.</p>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { supabase } from '../../lib/supabase';

    interface Student {
        id: number;
        absent_no: number;
        full_name: string;
        is_linked: boolean;
        linked_user_id: string | null;
        linked_profile?: {
            username: string;
            full_name: string;
            id: string;
        };
    }

    interface Profile {
        id: string;
        username: string;
        full_name: string;
    }

    let students: Student[] = [];
    let users: Profile[] = [];

    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/login'; return; }
        loadData();
    }

    async function loadData() {
        const { data: studentList } = await supabase
            .from('student_directory')
            .select('*, linked_profile:profiles(username, full_name, id)')
            .order('absent_no', { ascending: true });
        
        const linkedUserIds = studentList?.filter((s: any) => s.linked_user_id).map((s: any) => s.linked_user_id) || [];
        
        const { data: userList } = await supabase
            .from('profiles')
            .select('id, username, full_name')
            .not('id', 'in', linkedUserIds.length > 0 ? `(${linkedUserIds.join(',')})` : '(00000000-0000-0000-0000-000000000000)');

        students = studentList || [];
        users = userList || [];

        renderStudents();
        renderUnlinkedUsers();
        renderStats();
    }

    function renderStats() {
        const stats = document.getElementById('directory-stats');
        if (!stats) return;
        const linkedCount = students.filter(s => s.is_linked).length;
        stats.innerText = `${linkedCount} / ${students.length} TERTAUT`;
    }

    function renderStudents() {
        const tbody = document.getElementById('directory-list');
        if (!tbody) return;

        tbody.innerHTML = students.map(s => `
            <tr class="hover:bg-white/5 transition-all group ${s.is_linked ? 'bg-emerald-500/5' : ''}">
                <td class="p-4 text-xs font-black text-slate-600">${String(s.absent_no).padStart(2, '0')}</td>
                <td class="p-4">
                    <div class="font-bold text-white group-hover:text-blue-400 transition-colors uppercase">${s.full_name}</div>
                </td>
                <td class="p-4">
                    <span class="px-2 py-0.5 rounded-xl text-[8px] font-black uppercase tracking-widest ${s.is_linked ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-slate-800 text-slate-500 border border-white/5'}">
                        ${s.is_linked ? 'TERTAUT' : 'KOSONG'}
                    </span>
                </td>
                <td class="p-4">
                    ${s.is_linked ? `
                        <div class="text-xs font-bold text-white">${s.linked_profile?.username || 'User'}</div>
                    ` : '<span class="text-xs text-slate-700 italic">Belum ada akun</span>'}
                </td>
                <td class="p-4 text-right flex gap-2 justify-end">
                    ${s.is_linked ? `
                        <button onclick="unlinkStudent(${s.id})" class="px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 text-red-500 text-[10px] font-black uppercase rounded-xl border border-red-500/20 cursor-pointer transition-all">Lepas</button>
                    ` : `
                        <button onclick="startLinking(${s.id})" class="px-3 py-1.5 bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 text-[10px] font-black uppercase rounded-xl border border-blue-500/20 cursor-pointer transition-all">Tautkan</button>
                    `}
                </td>
            </tr>
        `).join('');
    }

    function renderUnlinkedUsers() {
        const container = document.getElementById('unlinked-users');
        if (!container) return;

        if (users.length === 0) {
            container.innerHTML = '<div class="text-center py-12 text-slate-800 font-bold italic border border-dashed border-white/5 rounded-2xl uppercase text-[10px] tracking-widest">Semua user tertaut</div>';
            return;
        }

        container.innerHTML = users.map(u => `
            <div class="p-4 bg-slate-800/50 border border-white/5 rounded-2xl hover:border-blue-500/20 transition-all group">
                <div class="flex justify-between items-center gap-3">
                    <div class="w-10 h-10 rounded-2xl bg-blue-600/10 border border-blue-500/20 flex items-center justify-center text-blue-400 font-black shadow-lg">
                        ${u.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-black text-white truncate">${u.username}</div>
                        <div class="text-[10px] text-slate-500 uppercase font-bold truncate">${u.full_name || 'No Name'}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    (window as any).startLinking = (studentId: number) => {
        const student = students.find(s => s.id === studentId);
        if (!student || users.length === 0) {
            alert('Tidak ada user yang tersedia untuk ditautkan.');
            return;
        }
        
        let options = users.map((u, i) => `${i+1}. ${u.username} (${u.full_name || 'No Name'})`).join('\n');
        let choice = prompt(`Pilih Akun untuk ditautkan ke nama "${student.full_name}":\n\n${options}\n\nKetik nomor urut (1-${users.length}):`);
        
        if (choice) {
            const idx = parseInt(choice) - 1;
            if (users[idx]) {
                processLink(student.id, users[idx].id);
            } else {
                alert('Pilihan tidak valid.');
            }
        }
    };

    async function processLink(studentId: number, userId: string) {
        const student = students.find(s => s.id === studentId);
        const user = users.find(u => u.id === userId);
        if(!student || !user) return;
        
        const ok = confirm(`Hubungkan akun "${user.username}" dengan nama asli "${student.full_name}"?`);
        
        if (ok) {
            const { error: dirError } = await supabase
                .from('student_directory')
                .update({ is_linked: true, linked_user_id: userId })
                .eq('id', studentId);
            
            if (dirError) { alert(dirError.message); return; }

            const { error: profError } = await supabase
                .from('profiles')
                .update({ full_name: student.full_name })
                .eq('id', userId);
            
            if (profError) console.error('Profil diperbarui tapi gagal set nama:', profError);

            loadData();
        }
    }

    (window as any).unlinkStudent = async (studentId: number) => {
        if (confirm('Lepas tautan akun dari nama ini?')) {
            const { error } = await supabase
                .from('student_directory')
                .update({ is_linked: false, linked_user_id: null })
                .eq('id', studentId);
            
            if (error) alert(error.message);
            else loadData();
        }
    };

    init();
    document.addEventListener('astro:after-swap', init);
</script>
