---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

export const prerender = false;
---

<Layout title="Manage Resources - Admin">
    <div class="max-w-7xl mx-auto px-6 py-12">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1 class="text-4xl font-black text-white tracking-tighter">Manage Resources</h1>
                <p class="text-slate-400 mt-2">Tambah dan kelola file di Resource Hub</p>
            </div>
            <a href="/resources" class="px-6 py-3 bg-white/5 hover:bg-white/10 text-white rounded-2xl font-bold border border-white/10 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                Lihat Hub
            </a>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Form Upload -->
            <div class="lg:col-span-1">
                <div class="bg-slate-900 border border-white/5 p-8 rounded-[2.5rem] shadow-2xl sticky top-8">
                    <h2 class="text-xl font-black text-white mb-8 uppercase tracking-tight flex items-center gap-3">
                        <span class="w-1.5 h-6 bg-cyan-500 rounded-full"></span>
                        Upload File Baru
                    </h2>
                    
                    <form id="upload-form" class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Judul Resource</label>
                            <input type="text" id="title" required class="w-full bg-slate-950 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-cyan-500/50 outline-none transition-all" placeholder="Contoh: ISO Debian 12">
                        </div>

                        <div>
                            <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Kategori</label>
                            <select id="category" class="w-full bg-slate-950 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-cyan-500/50 outline-none transition-all appearance-none cursor-pointer">
                                <option value="ISO">ISO Image</option>
                                <option value="PDF">Dokumen PDF</option>
                                <option value="Config">Konfigurasi</option>
                                <option value="Software">Software/Tool</option>
                                <option value="Tutorial">Tutorial</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">Deskripsi Singkat</label>
                            <textarea id="description" rows="3" class="w-full bg-slate-950 border border-white/10 rounded-2xl p-4 text-white focus:ring-2 focus:ring-cyan-500/50 outline-none transition-all resize-none" placeholder="Jelaskan isi file ini..."></textarea>
                        </div>

                        <div>
                            <label class="block text-[10px] font-black uppercase tracking-[0.2em] mb-3 text-slate-500">File Utama</label>
                            <div class="relative group">
                                <input type="file" id="file-input" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                <div class="w-full bg-slate-950 border-2 border-dashed border-white/10 rounded-2xl p-8 text-center group-hover:border-cyan-500/30 transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mx-auto text-slate-600 mb-4 group-hover:text-cyan-500 transition-colors"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    <p id="file-name" class="text-xs font-bold text-slate-500 truncate">Klik atau drop file di sini</p>
                                </div>
                            </div>
                            <p class="text-[9px] text-slate-600 mt-2 italic">*Pastikan Bucket 'resources' sudah dibuat di Supabase Storage sebagai Public.</p>
                        </div>

                        <button type="submit" id="submit-btn" class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 text-white rounded-2xl font-black uppercase tracking-[0.2em] text-xs shadow-xl shadow-cyan-600/20 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                            Publish Resource
                        </button>
                        <!-- Cancel Upload Button (hidden initially) -->
                        <button type="button" id="cancel-btn" class="hidden w-full py-4 bg-red-600 hover:bg-red-500 text-white rounded-2xl font-black uppercase tracking-[0.2em] text-xs shadow-xl shadow-red-600/20 transition-all active:scale-95 mt-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            Cancel Upload
                        </button>

                        <!-- Progress Bar (Hidden by default) -->
                        <div id="progress-container" class="hidden space-y-3 pt-6">
                            <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest">
                                <span class="text-cyan-400 animate-pulse">Network Transfer...</span>
                                <span id="progress-percent" class="text-white text-xs">0%</span>
                            </div>
                            <div class="w-full h-4 bg-slate-950 rounded-full border border-white/10 relative overflow-hidden shadow-inner">
                                <div id="progress-bar" class="absolute left-0 top-0 h-full bg-cyan-500 shadow-[0_0_20px_rgba(6,182,212,0.8)] animate-pulse z-20" style="width: 0%;"></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- List Table -->
            <div class="lg:col-span-2">
                <div class="bg-slate-900 border border-white/5 rounded-[2.5rem] overflow-hidden shadow-2xl">
                    <div class="p-8 border-b border-white/5 bg-white/2">
                        <h2 class="text-xl font-black text-white uppercase tracking-tight">Daftar Materi Aktif</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-950 text-slate-500 text-[10px] font-black uppercase tracking-widest">
                                <tr>
                                    <th class="p-6">Informasi File</th>
                                    <th class="p-6">Kategori</th>
                                    <th class="p-6">Statistik</th>
                                    <th class="p-6 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="resource-list" class="divide-y divide-white/5">
                                <!-- Loaded via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals / Toast Container here if needed -->
</Layout>

<script>
    import { supabase } from '../../lib/supabase';

    let resources: any[] = [];
    const form = document.getElementById('upload-form') as HTMLFormElement;
    const fileInput = document.getElementById('file-input') as HTMLInputElement;
    const fileNameDisplay = document.getElementById('file-name');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const cancelBtn = document.getElementById('cancel-btn') as HTMLButtonElement;
    let currentXhr: XMLHttpRequest | null = null;

    // Cancel upload handler
    cancelBtn?.addEventListener('click', () => {
        if (!currentXhr) return;
        if (confirm('Apakah Anda yakin ingin membatalkan upload?')) {
            currentXhr.abort();
            const bar = document.getElementById('progress-bar');
            const percent = document.getElementById('progress-percent');
            const container = document.getElementById('progress-container');
            if (bar) bar.style.width = '0%';
            if (percent) percent.innerText = '0%';
            if (container) container.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.innerText = 'PUBLISH RESOURCE';
            cancelBtn.classList.add('hidden');
            alert('Upload dibatalkan');
            currentXhr = null;
        }
    });

    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/login'; return; }
        loadResources();
    }

    async function loadResources() {
        const { data } = await supabase.from('resources').select('*').order('created_at', { ascending: false });
        resources = data || [];
        renderResources();
    }

    function renderResources() {
        const list = document.getElementById('resource-list');
        if (!list) return;

        if (resources.length === 0) {
            list.innerHTML = '<tr><td colspan="4" class="p-20 text-center text-slate-600 font-bold uppercase tracking-widest italic">Belum ada file diunggah</td></tr>';
            return;
        }

        list.innerHTML = resources.map(res => `
            <tr class="group hover:bg-white/5 transition-all">
                <td class="p-6">
                    <div class="font-black text-white uppercase tracking-tight mb-1">${res.title}</div>
                    <div class="text-[10px] text-slate-500 font-medium truncate max-w-xs">${res.description || '-'}</div>
                </td>
                <td class="p-6">
                    <span class="px-3 py-1 rounded-full bg-cyan-500/10 border border-cyan-500/20 text-[9px] font-black text-cyan-400 uppercase tracking-widest">${res.category}</span>
                </td>
                <td class="p-6">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-slate-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">${res.download_count} DLs</span>
                    </div>
                </td>
                <td class="p-6 text-right">
                    <button onclick="deleteResource('${res.id}', '${res.file_url}')" class="p-3 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-xl border border-red-500/20 transition-all cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    fileInput.addEventListener('change', (e: any) => {
        const file = e.target.files[0];
        if (file && fileNameDisplay) {
            fileNameDisplay.innerText = file.name;
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = fileInput.files?.[0];
        if (!file) return;

        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        
        submitBtn.disabled = true;
        submitBtn.innerText = 'PREPARING...';
        progressContainer?.classList.remove('hidden');
        cancelBtn?.classList.remove('hidden');

        try {
            // 1. Setup Manual XHR for Reliable Progress
            const { data: { session } } = await supabase.auth.getSession();
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExt}`;
            const bucket = 'resources';
            
            // @ts-ignore - access internal URL if PUBLIC_SUPABASE_URL is not exported
            const supabaseUrl = (supabase as any).supabaseUrl || import.meta.env.PUBLIC_SUPABASE_URL;
            const uploadUrl = `${supabaseUrl}/storage/v1/object/${bucket}/${fileName}`;

            const xhr = new XMLHttpRequest();
            currentXhr = xhr; // Store reference for cancel button
            xhr.open('POST', uploadUrl, true);
            
            // Headers for Supabase
            xhr.setRequestHeader('apikey', (supabase as any).supabaseKey || import.meta.env.PUBLIC_SUPABASE_ANON_KEY);
            xhr.setRequestHeader('Authorization', `Bearer ${session?.access_token}`);
            xhr.setRequestHeader('x-upsert', 'false');

            const uploadPromise = new Promise((resolve, reject) => {
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percentage = Math.round((event.loaded / event.total) * 100);
                        if (progressBar) {
                            progressBar.style.width = percentage + '%';
                        }
                        if (progressPercent) progressPercent.innerText = percentage + '%';
                        submitBtn.innerText = `UPLOADING ${percentage}%`;
                    }
                };

                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error(xhr.statusText || 'Upload failed'));
                    }
                };

                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send(file);
            });

            submitBtn.innerText = 'STARTING UPLOAD...';
            await uploadPromise;

            // 2. Get Public URL
            const { data: { publicUrl } } = supabase.storage
                .from(bucket)
                .getPublicUrl(fileName);

            // 3. Save to Database
            const { error: dbError } = await supabase.from('resources').insert({
                title: (document.getElementById('title') as HTMLInputElement).value,
                description: (document.getElementById('description') as HTMLTextAreaElement).value,
                category: (document.getElementById('category') as HTMLSelectElement).value,
                file_url: publicUrl,
                created_by: session?.user.id
            });

            if (dbError) throw dbError;

            alert('Resource Berhasil Dipublikasi!');
            form.reset();
            fileNameDisplay!.innerText = 'Klik atau drop file di sini';
            progressContainer?.classList.add('hidden');
            if (progressBar) (progressBar as HTMLElement).style.width = '0%';
            loadResources();

        } catch (err: any) {
            console.error('Upload Error:', err);
            alert('Error: ' + err.message);
            progressContainer?.classList.add('hidden');
            cancelBtn?.classList.add('hidden');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = 'PUBLISH RESOURCE';
            currentXhr = null;
            cancelBtn?.classList.add('hidden');
        }
    });

    (window as any).deleteResource = async (id: string, fileUrl: string) => {
        if (!confirm('Hapus resource ini selamanya?')) return;

        try {
            // 1. Delete from DB
            const { error: dbError } = await supabase.from('resources').delete().eq('id', id);
            if (dbError) throw dbError;

            // 2. Optionally delete from storage (need to parse fileName from URL)
            const fileName = fileUrl.split('/').pop();
            if (fileName) {
                await supabase.storage.from('resources').remove([fileName]);
            }

            loadResources();
        } catch (err: any) {
            alert('Error: ' + err.message);
        }
    };

    init();
    document.addEventListener('astro:after-swap', init);
</script>
